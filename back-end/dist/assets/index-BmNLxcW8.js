(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function s(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(e){if(e.ep)return;e.ep=!0;const n=s(e);fetch(e.href,n)}})();const vt="SensorMonitorDB",It=1,D="humidityUpdates",C="phUpdates";let b;function Dt(){return new Promise((t,o)=>{const s=indexedDB.open(vt,It);s.onerror=a=>{console.error("Error opening IndexedDB:",a.target.errorCode),o(a.target.errorCode)},s.onsuccess=a=>{b=a.target.result,console.log("IndexedDB opened successfully"),t(b)},s.onupgradeneeded=a=>{const e=a.target.result;e.objectStoreNames.contains(C)||(e.createObjectStore(C,{keyPath:"id",autoIncrement:!0}),console.log(`Object store '${C}' created.`)),e.objectStoreNames.contains(D)||(e.createObjectStore(D,{keyPath:"id",autoIncrement:!0}),console.log(`Object store '${D}' created.`))}})}function Ct(t){if(!b){console.warn("IndexedDB not open. Cannot save pH data.");return}if(!t||typeof t!="object"){console.warn("Invalid pH data. Not saving to IndexedDB.");return}"id"in t&&delete t.id;const a=b.transaction([C],"readonly").objectStore(C).openCursor(null,"prev");a.onsuccess=e=>{const n=e.target.result;if(n&&n.value.phValue===t.phValue){console.warn("pH data is a duplicate of the immediately previous record. Not saving.");return}const d=b.transaction([C],"readwrite").objectStore(C).add(t);d.onsuccess=()=>{console.log("pH data successfully saved to IndexedDB.")},d.onerror=l=>{console.error("Error saving pH data to IndexedDB:",l.target.errorCode)}},a.onerror=e=>{console.error("Error checking for duplicate pH data in IndexedDB:",e.target.errorCode)}}function kt(t){if(!b){console.warn("IndexedDB not open. Cannot save humidity data.");return}if(!t||typeof t!="object"){console.warn("Invalid humidity data. Not saving to IndexedDB.");return}"id"in t&&delete t.id;const a=b.transaction([D],"readonly").objectStore(D).openCursor(null,"prev");a.onsuccess=e=>{const n=e.target.result;if(n&&n.value.humidityValue===t.humidityValue){console.warn("Humidity data is a duplicate of the immediately previous record. Not saving.");return}const d=b.transaction([D],"readwrite").objectStore(D).add(t);d.onsuccess=()=>{console.log("Humidity data successfully saved to IndexedDB.")},d.onerror=l=>{console.error("Error saving Humidity data to IndexedDB:",l.target.errorCode)}},a.onerror=e=>{console.error("Error checking for duplicate humidityValue in IndexedDB:",e.target.errorCode)}}function dt(t=8){return new Promise((o,s)=>{if(!b){console.warn("IndexedDB not open. Cannot get data."),o([]);return}const n=b.transaction([D],"readonly").objectStore(D).openCursor(null,"prev"),i=[];n.onsuccess=r=>{const d=r.target.result;d&&i.length<t?(i.push(d.value),d.continue()):o(i)},n.onerror=r=>{console.error("Error getting data from IndexedDB:",r.target.errorCode),s(r.target.errorCode)}})}function lt(t=8){return new Promise((o,s)=>{if(!b){console.warn("IndexedDB not open. Cannot get data."),o([]);return}const n=b.transaction([C],"readonly").objectStore(C).openCursor(null,"prev"),i=[];n.onsuccess=r=>{const d=r.target.result;d&&i.length<t&&(i.push(d.value),d.continue())},n.onerror=r=>{console.error("Error getting data from IndexedDB:",r.target.errorCode),s(r.target.errorCode)}})}function Bt(t="ph_data.csv"){return new Promise((o,s)=>{if(!b){console.warn("IndexedDB not open. Cannot get data."),s("IndexedDB not open");return}const n=b.transaction([C],"readonly").objectStore(C).openCursor();let i=[],r=[],d=!0;n.onsuccess=l=>{const u=l.target.result;if(u){const p=u.value;d&&(r=Object.keys(p),i.push(r.join(",")),d=!1);const m=r.map(g=>{let c=p[g];return c===null||typeof c>"u"?"":typeof c=="string"&&(c.includes(",")||c.includes('"')||c.includes(`
`))?`"${c.replace(/"/g,'""')}"`:c}).join(",");i.push(m),u.continue()}else{console.log("semua data telah diiterasi");const p=i.join(`
`),m=new Blob([p],{type:"text/csv;charset=utf-8;"}),g=URL.createObjectURL(m),c=document.createElement("a");c.href=g,c.download=t,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(g),console.log(`Data exported to ${t}`),o()}},n.onerror=l=>{console.error("Error download data from IndexedDB:",l.target.errorCode),s(l.target.errorCode)}})}function Et(t="humidity_data.csv"){return new Promise((o,s)=>{if(!b){console.warn("IndexedDB not open. Cannot get data."),s("IndexedDB not open");return}const n=b.transaction([D],"readonly").objectStore(D).openCursor();let i=[],r=[],d=!0;n.onsuccess=l=>{const u=l.target.result;if(u){const p=u.value;d&&(r=Object.keys(p),i.push(r.join(",")),d=!1);const m=r.map(g=>{let c=p[g];return c===null||typeof c>"u"?"":typeof c=="string"&&(c.includes(",")||c.includes('"')||c.includes(`
`))?`"${c.replace(/"/g,'""')}"`:c}).join(",");i.push(m),u.continue()}else{console.log("semua data telah diiterasi");const p=i.join(`
`),m=new Blob([p],{type:"text/csv;charset=utf-8;"}),g=URL.createObjectURL(m),c=document.createElement("a");c.href=g,c.download=t,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(g),console.log(`Data exported to ${t}`),o()}},n.onerror=l=>{console.error("Error download data from IndexedDB:",l.target.errorCode),s(l.target.errorCode)}})}const Lt="ae2f0qpfo130e-ats.iot.ap-southeast-1.amazonaws.com",ut="ap-southeast-1",xt="ap-southeast-1:66f016b1-04c1-4719-8774-bf55d732f161";AWS.config.region=ut;AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:xt});let N;const At=async()=>{try{await new Promise((o,s)=>{AWS.config.credentials.get(a=>{a?s(a):o()})}),console.log("✅ Cognito Credentials loaded.");const t=Mt.getSignedUrl(Lt,ut,AWS.config.credentials.accessKeyId,AWS.config.credentials.secretAccessKey,AWS.config.credentials.sessionToken);N=mqtt.connect(t,{reconnectPeriod:5e3,clientId:"webclient_"+Math.floor(Math.random()*1e4),protocol:"wss",clean:!0}),N.on("connect",()=>{console.log("✅ MQTT connected")}),N.on("error",o=>{console.error("❌ MQTT Error:",o)})}catch(t){console.error("❌ Gagal load Cognito credentials:",t)}};window.nyalakanPompa=()=>{if(!N||!N.connected){console.error("🚫 MQTT belum terkoneksi. Tidak bisa publish.");return}const t=moment().format("YYYY-MM-DD HH:mm:ss"),o=document.getElementById("flushButton");o.classList.add("opacity-80"),o.disabled=!0,o.textContent="Sending ...",setTimeout(()=>{o.textContent="Flushing ..."},2e3),setTimeout(()=>{o.classList.remove("opacity-80"),o.disabled=!1,o.textContent="Flush"},3e4);const s=JSON.stringify({action:"nyala"});N.publish("device/pompa",s,{qos:1},a=>{a?console.error("🚫 Publish error:",a):console.log("📤 Pompa nyala command dikirim pada",t)})};const Mt={getSignedUrl:function(t,o,s,a,e){const n=new Date,i=n.toISOString().slice(0,10).replace(/-/g,""),r=n.toISOString().replace(/[:-]|\.\d{3}/g,""),d="iotdevicegateway",l="AWS4-HMAC-SHA256",u="GET",p="/mqtt",m=i+"/"+o+"/"+d+"/aws4_request",g="X-Amz-Algorithm="+l+"&X-Amz-Credential="+encodeURIComponent(s+"/"+m)+"&X-Amz-Date="+r+"&X-Amz-SignedHeaders=host",c="host:"+t+`
`,w=AWS.util.crypto.sha256("","hex"),k=u+`
`+p+`
`+g+`
`+c+`
host
`+w,S=l+`
`+r+`
`+m+`
`+AWS.util.crypto.sha256(k,"hex"),v=AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac("AWS4"+a,i,"buffer"),o,"buffer"),d,"buffer"),"aws4_request","buffer"),j=AWS.util.crypto.hmac(v,S,"hex");let R="wss://"+t+p+"?"+g+"&X-Amz-Signature="+j;return e&&(R+="&X-Amz-Security-Token="+encodeURIComponent(e)),R}};function nt(t,o){const s=[],a={};t.forEach(n=>{const i=new Date(n.timestamp);new Date(i.getTime()+7*60*60*1e3);const r=i.getHours().toString().padStart(2,"0")+":00",d=n[o];d&&typeof d.average=="number"&&(a[r]=parseFloat(d.average.toFixed(2)))});let e=null;for(let n=0;n<24;n++){const i=n.toString().padStart(2,"0")+":00";a[i]!=null&&(e=a[i]),s.push({time:i,value:e!==null?e:null})}return s}let h,W=!1,V=!1;const Tt=()=>{const t=sessionStorage.getItem("currentView"),o=sessionStorage.getItem("humidityDetailData");t==="second"&&o==="true"?W=!0:t==="second"&&o==="false"&&(W=!1)};function Pt(){h&&h.readyState===WebSocket.OPEN?(h.send(JSON.stringify({action:"getHistoryData"})),V=!1):V=!0}const mt=()=>{if(h&&h.readyState!==WebSocket.CLOSED&&h.readyState!==WebSocket.CLOSING){console.log("WebSocket sudah aktif. Tidak membuat koneksi baru.");return}const t="wss://chili-monitor-data.andzuru.space";h=new WebSocket(t),h.onopen=async()=>{console.log("✅ WebSocket connected to",t),V&&(h.send(JSON.stringify({action:"getHistoryData"})),V=!1)},h.onmessage=o=>{try{const s=JSON.parse(o.data);if(console.log("📨 Data diterima:",s),s.topic==="historicalData"){const f=s.data;if(console.log(f),W===!0){if(f&&Array.isArray(f)){const I=nt(f,"kelembapan");console.log(I);const B=I.map(x=>x.time),_=I.map(x=>x.value);ct(B,_)}}else if(f&&Array.isArray(f)){const I=nt(f,"ph");console.log(I);const B=I.map(x=>x.time),_=I.map(x=>x.value);ct(B,_)}}const{topic:a,data:e,chartData:n,timestamp:i}=s,{ph:r,humidity:d}=n||{};let l=null;if(r&&Array.isArray(r.timestamps)&&r.timestamps.length>0){let f=r.timestamps[r.timestamps.length-1];typeof f=="string"&&f?l=new Date(f).toISOString():typeof f=="number"&&!isNaN(f)&&(f<1e10&&(f*=1e3),l=new Date(f).toISOString())}let u=null;if(d&&Array.isArray(d.timestamps)&&d.timestamps.length>0){let f=d.timestamps[d.timestamps.length-1];typeof f=="string"&&f?u=new Date(f).toISOString():typeof f=="number"&&!isNaN(f)&&(f<1e10&&(f*=1e3),u=new Date(f).toISOString())}const p=Date.now(),m=isNaN(Number(i))?0:p-Number(i),g=isNaN(Number(i))?null:new Date(Number(i)+7*60*60*1e3).toISOString(),c=new Date(p+7*60*60*1e3).toISOString();let w,k;e&&(e.Kelembapan!==void 0&&e.Kelembapan!==null&&!isNaN(parseFloat(e.Kelembapan))?(window.latestRecordHumidity={timestampCloudReceived:g,timestampBrowserReceived:c,latency:parseFloat(m),humidityValue:parseFloat(e.Kelembapan),humidityDataReceivedAt:u},w=window.latestRecordHumidity):console.log("Kelembapan tidak ada pembaharuan data"),e.Ph!==void 0&&e.Ph!==null&&!isNaN(parseFloat(e.Ph))?(window.latestRecordPh={timestampCloudReceived:g,timestampBrowserReceived:c,latency:parseFloat(m),phValue:parseFloat(e.Ph),phDataReceivedAt:l},k=window.latestRecordPh):console.log("PH tidak ada pembaharuan data"));const S=parseFloat((e==null?void 0:e.Ph)??"NaN"),v=parseFloat((e==null?void 0:e.Kelembapan)??"NaN"),j=isNaN(S)?"N/A":S.toFixed(1),R=isNaN(v)?"N/A":v.toFixed(1),Z=document.getElementById("phValue"),tt=document.getElementById("humidityValue"),et=document.getElementById("ground-good-status"),ot=document.getElementById("ground-poor-status");if(!isNaN(S)&&!isNaN(v)&&(S>9.5||S<5||v>90||v<10)?(et.classList.add("hidden"),ot.classList.remove("hidden")):(ot.classList.add("hidden"),et.classList.remove("hidden")),Z&&(Z.textContent=j),tt&&(tt.textContent=R),n){if(r&&Array.isArray(r.timestamps)&&Array.isArray(r.values)){const f=r.timestamps.map(Number),I=r.values.map(Number);navigator.onLine?(Ut(f,I),Ct(k)):lt(1).then(B=>{B&&B.length>0&&setTimeout(Vt,200)})}if(d&&Array.isArray(d.timestamps)&&Array.isArray(d.values)){const f=d.timestamps.map(Number),I=d.values.map(Number);navigator.onLine?(Kt(f,I),kt(w)):dt(1).then(B=>{B&&B.length>0&&setTimeout(Yt,200)})}}}catch(s){console.error("❌ Error parsing WebSocket message:",s)}},h.onerror=o=>{console.error("⚠️ WebSocket error:",o)},h.onclose=o=>{console.warn(`⚠️ WebSocket disconnected. Code: ${o.code}, Reason: ${o.reason}`),setTimeout(()=>{console.log("🔁 Mencoba reconnect WebSocket..."),mt()},5e3)}},st="BEr7RhsHyH-U39qwfNHjCgsxD3_cBFL17xttbkvTWYbavxeJoED-IKkSf1Ui4CUYiIdGsNeknYBqeEjVuIFQgFc";function at(t){const o="=".repeat((4-t.length%4)%4),s=(t+o).replace(/\-/g,"+").replace(/_/g,"/"),a=window.atob(s),e=new Uint8Array(a.length);for(let n=0;n<a.length;++n)e[n]=a.charCodeAt(n);return e}async function rt(t,o){if(!o)throw console.error("No auth token found"),new Error("Authentication token is missing.");const s="https://chili-monitor-data.andzuru.space/api/save-subscription";console.log("Preparing subscription data for backend...");const a=t.getKey("p256dh"),e=t.getKey("auth");if(!a||!e)throw console.error("Subscription keys are missing"),new Error("Subscription keys are missing");const n={endpoint:t.endpoint,keys:{p256dh:btoa(String.fromCharCode(...new Uint8Array(a))),auth:btoa(String.fromCharCode(...new Uint8Array(e)))}};console.log("Sending subscription to backend:",n);try{const i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(n)}),r=await i.json();if(!i.ok)throw console.error("Backend subscription error:",r),new Error(r.message||"Failed to send subscription to backend");return console.log("Backend subscription successful:",r),r}catch(i){throw console.error("Subscription error:",i),i}}async function it(t,o){if(!o)throw console.error("No auth token found"),new Error("Authentication token is missing.");const s="https://chili-monitor-data.andzuru.space/api/delete-subscription",a={endpoint:t};try{const e=await fetch(s,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(a)}),n=await e.json();if(!e.ok)throw new Error(n.message||"Failed to send unsubscription to backend");return console.log("Unsubscription sent to backend successfully:",n),n}catch(e){throw console.error("Error sending unsubscription to backend:",e),e}}async function z(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return{supported:!1,subscribed:!1,error:"Push notification not supported"};try{const o=await(await navigator.serviceWorker.ready).pushManager.getSubscription();return{supported:!0,subscribed:!!o,subscriptionObject:o}}catch{return{supported:!0,subscribed:!1,error:"Failed to check subscription status."}}}function P(t){const o=document.getElementById("subscribeBtn"),s=document.getElementById("subscribeBtnMobile");o&&s&&(t?(o.textContent="Unsubscribe",o.classList.remove("text-primary","hover:text-tersier"),o.classList.add("bg-primary","px-6","text-white","rounded-full","transition-colors","hover:text-primary","hover:bg-white"),s.textContent="Unsubscribe",s.classList.remove("group-hover:text-tersier"),s.classList.add("bg-primary","px-6","text-white","rounded-full","transition-colors","hover:text-primary","hover:bg-white")):(o.textContent="Subscribe",o.classList.remove("bg-primary","px-6","text-white","rounded-full","hover:bg-white","hover:text-primary"),o.classList.add("text-primary","hover:text-tersier"),s.textContent="Subscribe",s.classList.remove("bg-primary","px-6","text-white","rounded-full","hover:bg-white","hover:text-primary"),s.classList.add("group-hover:text-tersier")))}async function Ht(){if(!("serviceWorker"in navigator)||!("PushManager"in window)){console.warn("Push notification tidak didukung.");return}try{const t=await navigator.serviceWorker.register("/sw.js");if(console.log("Service Worker terdaftar:",t),await Notification.requestPermission()==="denied"){console.warn("Izin notifikasi tidak diberikan"),P(!1);return}const s=await z();P(s.subscribed)}catch(t){console.error("Gagal setup push notification:",t)}}function Nt(t=8){return Math.random().toString(36).substring(2,2+t)}function y(t,o){const s=document.getElementById("modal-notif-container"),a=document.getElementById("modal-notif-alert"),e=document.getElementById("modal-main-notif"),n=document.getElementById("title-notif-modal"),i=document.getElementById("content-notif-modal"),r=document.getElementById("close-notif");if(!s||!a||!e||!i||!r){console.error("Modal elements not found in the DOM");return}i.textContent=o,n.textContent=t,s.classList.remove("hidden"),a.classList.remove("hidden"),r.onclick=()=>{s.classList.add("hidden"),a.classList.add("hidden")},window.onclick=d=>{!e.contains(d.target)&&d.target===s&&(s.classList.add("hidden"),a.classList.add("hidden"))}}function gt(t,o){const s=document.getElementById("modal-notif-container"),a=document.getElementById("modal-notif-alert"),e=document.getElementById("modal-main-notif"),n=document.getElementById("title-notif-modal"),i=document.getElementById("content-notif-modal"),r=document.getElementById("close-notif"),d=document.getElementById("button-container"),l=document.getElementById("detail-confirm");if(!s||!a||!e||!i||!r||!d){console.error("Modal elements not found in the DOM");return}l&&l.remove();const u=document.createElement("button");u.id="detail-confirm",u.className="bg-primary w-[200px] text-white px-4 py-2 rounded-lg hover:bg-tersier active:bg-secondary",u.textContent="OK";let p=document.getElementById("myChart"),m=document.getElementById("myChart1");const g=sessionStorage.getItem("humidityDetailData");u.onclick=c=>{const w={action:"getHistoryData"};h.readyState===WebSocket.OPEN&&h.send(JSON.stringify(w)),W=g==="true",jt(),M.data.datasets[0].label=g==="true"?"Soil Moisture":"Soil pH",M.update(),s.classList.add("hidden"),a.classList.add("hidden"),c.currentTarget.remove()},d.appendChild(u),n.textContent=t,i.textContent=o,s.classList.remove("hidden"),a.classList.remove("hidden"),r.onclick=()=>{s.classList.add("hidden"),a.classList.add("hidden"),l&&l.remove()},window.onclick=c=>{!e.contains(c.target)&&!l.contains(c.target)&&!r.contains(c.target)&&!p.contains(c.target)&&!m.contains(c.target)&&(s.classList.add("hidden"),a.classList.add("hidden"),l&&l.remove())}}function Ot(t,o){const s=document.getElementById("modal-notif-container"),a=document.getElementById("modal-notif-alert"),e=document.getElementById("modal-main-notif"),n=document.getElementById("title-notif-modal"),i=document.getElementById("content-notif-modal"),r=document.getElementById("close-notif"),d=document.getElementById("button-container"),l=document.getElementById("input-column-container"),u=document.getElementById("password-input"),p=document.getElementById("toggle-password"),m=document.getElementById("detail-confirm");if(!s||!a||!e||!i||!r||!d){console.error("Modal elements not found in the DOM");return}m&&m.remove();const g=document.createElement("button");g.id="detail-confirm",g.className="bg-primary w-[200px] text-white px-4 py-2 rounded-lg hover:bg-tersier active:bg-secondary",g.textContent="Confirm",d.appendChild(g),l.classList.remove("hidden"),l.classList.add("flex"),g.onclick=c=>{const w="Ok!",k=u.value;if(k===w){u.value="",l.classList.add("hidden"),l.classList.remove("flex");const S="Pump Activated",v="Pump activated for 15 seconds";window.nyalakanPompa();const j={action:"pumpIsActive"};h&&h.readyState===WebSocket.OPEN&&h.send(JSON.stringify(j)),s.classList.add("hidden"),a.classList.add("hidden"),c.currentTarget.remove(),y(S,v)}else if(k===""||k!==w){u.value="",l.classList.add("hidden"),l.classList.remove("flex");const S="Incorrect Password",v="The password you entered is incorrect. Please try again.";s.classList.add("hidden"),a.classList.add("hidden"),c.currentTarget.remove(),y(S,v)}},n.textContent=t,i.textContent=o,s.classList.remove("hidden"),a.classList.remove("hidden"),r.onclick=()=>{s.classList.add("hidden"),a.classList.add("hidden"),m&&m.remove(),u.value="",l.classList.add("hidden"),l.classList.remove("flex")},window.onclick=c=>{!e.contains(c.target)&&!(m&&m.contains(c.target))&&!r.contains(c.target)&&!l.contains(c.target)&&!(p&&p.closest(c.target))&&(s.classList.add("hidden"),a.classList.add("hidden"),m&&m.remove(),u.value="",l.classList.add("hidden"),l.classList.remove("flex"))}}async function pt(t=0){if(t>=5)return console.error("Failed to auto-register after multiple attempts due to duplicate username/email."),y("Registration Failed","Failed to auto-register after multiple attempts due to duplicate username/email."),!1;const s=Nt(6),a=`user${s}`,e=`user${s}@example.com`,n="password123";try{console.log(`Attempting to register with: Username=${a}, Email=${e}`);const i=await fetch("https://chili-monitor-data.andzuru.space/api/register-auto-login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:a,email:e,password:n})}),r=await i.json();if(i.ok&&r.success)return console.log("Registration successful, token received:",r.token),localStorage.setItem("userToken",r.token),localStorage.setItem("userToken_createdAt",Date.now()),y("Registration Successful","Registration successful! You have automatically logged in."),!0;if(i.status===409)return console.warn("Username or email already exists. Retrying with new random values."),pt(t+1);{console.error("Registration failed:",r.message||"Unknown error",r);const d="Registration Failed",l=`Registration failed: ${r.message||"An error occurred during registration."}`;return y(d,l),!1}}catch(i){return console.error("Error during registration:",i),y("Registration Failed","An error occurred during registration."),!1}}function Ft(t){if(!t)return!1;try{const o=t.split(".");if(o.length!==3)return!1;const s=JSON.parse(atob(o[1]));if(s.exp){const a=Math.floor(Date.now()/1e3);if(s.exp<a)return console.log("Token expired locally."),!1}return!0}catch(o){return console.error("Error decoding or validating token locally:",o),!1}}function jt(){U.classList.add("hidden"),$.classList.remove("hidden"),sessionStorage.setItem("currentView","second")}function Rt(){$.classList.add("hidden"),U.classList.remove("hidden"),sessionStorage.setItem("currentView","main")}document.addEventListener("DOMContentLoaded",async()=>{Tt(),mt(),At(),Dt().then(()=>{}).catch(u=>console.error("Failed to open IndexedDB:",u));const t=sessionStorage.getItem("currentView"),o=sessionStorage.getItem("humidityDetailData");if(t==="second"){U.classList.add("hidden"),$.classList.remove("hidden"),M.data.datasets[0].label=o==="true"?"Soil Moisture":"Soil pH",M.update(),console.log("web dalam tampilan second view, bersiap mengirim getHistoryData");try{Pt()}catch(u){console.log("terjadi error saat mengirimkan getHistoryData :",u)}}else U.classList.remove("hidden"),$.classList.add("hidden"),sessionStorage.removeItem("humidityDetailData");let s=localStorage.getItem("userToken"),a=localStorage.getItem("userToken_createdAt");const e=24*60*60*1e3;if(s&&Ft(s)&&Date.now()-a<e)console.log("Valid user token found in localStorage:",s);else if(console.log("No valid user token found or token expired/too old. Attempting to auto-register and login."),localStorage.removeItem("userToken"),localStorage.removeItem("userToken_createdAt"),await pt())s=localStorage.getItem("userToken"),console.log("Auto-registration and login successful. New Token:",s);else{console.error("Auto-registration and login failed. User cannot proceed without a token."),y("Registration Failed","Failed to obtain a user session. Certain functions may not work.");return}await Ht();const n=document.getElementById("subscribeBtn"),i=document.getElementById("subscribeBtnMobile");n&&n.addEventListener("click",async()=>{const u=localStorage.getItem("userToken");if(!u){y("Subscription Failed","User session not found. Please refresh the page to get a new session.");return}const p=await z();if(p.subscribed)try{await it(p.subscriptionObject.endpoint,u),await p.subscriptionObject.unsubscribe(),console.log("Successfully unsubscribed!"),P(!1),y("Successfully Unsubscribed","You have successfully unsubscribed from push notifications.")}catch(m){console.error("Error unsubscribing:",m),y("Unsubscription Failed","Failed to unsubscribe. Please try again.")}else try{const m=await navigator.serviceWorker.ready,g=at(st),c=await m.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:g});await rt(c,u),console.log("Successfully subscribed!"),P(!0),y("Successful Subscription","You have successfully subscribed to push notifications!")}catch(m){console.error("Error subscribing:",m),y("Subscription Failed","Failed to subscribe. Please ensure notifications are enabled and try again.")}}),i&&i.addEventListener("click",async()=>{const u=localStorage.getItem("userToken");if(!u){y("Unsubscription Failed","User session not found. Please refresh the page to get a new session.");return}const p=await z();if(p.subscribed)try{await it(p.subscriptionObject.endpoint,u),await p.subscriptionObject.unsubscribe(),console.log("Successfully unsubscribed (Mobile)!"),P(!1),y("Unsubscription Failed","You have successfully unsubscribed from push notifications.")}catch(m){console.error("Error unsubscribing (Mobile):",m),y("Unsubscription Failed","Failed to unsubscribe. Please try again.")}else try{const m=await navigator.serviceWorker.ready,g=at(st),c=await m.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:g});await rt(c,u),console.log("Successfully subscribed (Mobile)!"),P(!0),y("Successfully subscribed (Mobile)!","You have successfully subscribed to push notifications!")}catch(m){console.error("Error subscribing (Mobile):",m),y("Successfully subscribed (Mobile)!","Failed to subscribe. Please ensure notifications are enabled and try again.")}});const r=localStorage.getItem("lastWelcomeBackShown"),d=6*60*60*1e3,l=Date.now();(!r||l-parseInt(r)>d)&&(y("Welcome Back!","It's good to see you again. ✨😊"),localStorage.setItem("lastWelcomeBackShown",l))});let ft=document.getElementById("myChart"),ht=document.getElementById("myChart1"),Wt=document.getElementById("detailChart");async function Vt(){const t=await lt();if(!t||t.length===0){E.data.datasets[0].data=[],E.data.labels=[],E.update();return}const o=t.slice().reverse(),s=o.map(e=>{const n=new Date(e.phDataReceivedAt),i=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),d=String(n.getDate()).padStart(2,"0"),l=String(n.getHours()).padStart(2,"0"),u=String(n.getMinutes()).padStart(2,"0"),p=String(n.getSeconds()).padStart(2,"0");return`${i}-${r}-${d} ${l}:${u}:${p}`}),a=o.map(e=>e.phValue);E.data.datasets[0].data=a,E.data.labels=s,E.update()}function Ut(t,o){function s(e){const n=new Date(e);n.getFullYear(),String(n.getMonth()+1).padStart(2,"0"),String(n.getDate()).padStart(2,"0");const i=String(n.getHours()).padStart(2,"0"),r=String(n.getMinutes()).padStart(2,"0");return String(n.getSeconds()).padStart(2,"0"),`${i}:${r}`}const a=t.map(e=>s(e));E.data.datasets[0].data=o,E.data.labels=a,E.update()}const $t={labels:[],datasets:[{label:"Soil pH",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2}]},qt={type:"line",data:$t,options:{scales:{y:{beginAtZero:!1}}}},E=new Chart(ht,qt);async function Yt(){const t=await dt();if(!t||t.length===0){L.data.datasets[0].data=[],L.data.labels=[],L.update();return}const o=t.slice().reverse(),s=o.map(e=>{const n=new Date(e.humidityDataReceivedAt),i=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),d=String(n.getDate()).padStart(2,"0"),l=String(n.getHours()).padStart(2,"0"),u=String(n.getMinutes()).padStart(2,"0"),p=String(n.getSeconds()).padStart(2,"0");return`${i}-${r}-${d} ${l}:${u}:${p}`}),a=o.map(e=>e.humidityValue);L.data.datasets[0].data=a,L.data.labels=s,L.update()}function Kt(t,o){function s(e){const n=new Date(e);n.getFullYear(),String(n.getMonth()+1).padStart(2,"0"),String(n.getDate()).padStart(2,"0");const i=String(n.getHours()).padStart(2,"0"),r=String(n.getMinutes()).padStart(2,"0");return String(n.getSeconds()).padStart(2,"0"),`${i}:${r}`}const a=t.map(e=>s(e));console.log(a),L.data.datasets[0].data=o,L.data.labels=a,L.update()}const _t={labels:[],datasets:[{label:"Soil Moisture",data:[],borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:2}]},zt={type:"line",data:_t,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!1}}}},L=new Chart(ft,zt);function ct(t,o){function s(a){const e=new Date(a);e.getFullYear(),String(e.getMonth()+1).padStart(2,"0"),String(e.getDate()).padStart(2,"0");const n=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0");return String(e.getSeconds()).padStart(2,"0"),`${n}:${i}`}t.map(a=>s(a)),M.data.datasets[0].data=o,M.data.labels=t,M.update()}const Jt={labels:[],datasets:[{data:[],borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:2}]},Gt={type:"line",data:Jt,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!1}}}},M=new Chart(Wt,Gt),U=document.getElementById("main-view"),$=document.getElementById("second-view"),Qt=document.getElementById("backToMainView");ft.addEventListener("click",()=>{sessionStorage.setItem("humidityDetailData","true"),gt("Details of Humidity Data","Would you like to view details of humidity data?")});ht.addEventListener("click",()=>{sessionStorage.setItem("humidityDetailData","false"),gt("Details of PH Data","Would you like to view details of pH data?")});Qt.addEventListener("click",()=>{Rt(),sessionStorage.removeItem("humidityDetailData");const t={action:"getMainViewData"};h.readyState===WebSocket.OPEN&&h.send(JSON.stringify(t))});const q=document.querySelector("#hamburger"),J=document.querySelector("#nav-menu");q.addEventListener("click",function(){q.classList.toggle("hamburger-active"),J.classList.toggle("hidden")});window.addEventListener("click",function(t){t.target!=q&&t.target!=J&&(q.classList.remove("hamburger-active"),J.classList.add("hidden"))});document.getElementById("toggle-password").addEventListener("click",function(){const t=document.getElementById("password-input"),o=document.getElementById("eye-icon"),s=t.type==="password";t.type=s?"text":"password",o.outerHTML=s?`
      <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none"
        viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a10.054 10.054 0 012.387-3.773M6.7 6.7A10.05 10.05 0 0112 5c4.477 0 8.268 2.943 9.542 7a10.05 10.05 0 01-4.233 5.605M3 3l18 18" />
      </svg>
    `:`
      <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none"
        viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
      </svg>
    `});const Y=document.getElementById("modal-container-1"),K=document.getElementById("modal-container-2"),O=document.getElementById("modal-confirm-download-container"),F=document.getElementById("modal-confirm-download-alert"),Xt=document.getElementById("modal-main"),Zt=document.getElementById("modal-main-download"),yt=document.getElementById("info-button"),bt=document.getElementById("close-modal"),A=document.getElementById("download-data"),G=document.getElementById("cancel-download"),Q=document.getElementById("get-ph-data-modal"),X=document.getElementById("get-humidity-data-modal"),H=document.getElementById("content-download-modal"),wt=document.getElementById("title-download-modal");let T=null;yt.addEventListener("click",()=>{Y.classList.remove("hidden"),K.classList.remove("hidden")});Q.addEventListener("click",()=>{O.classList.remove("hidden"),F.classList.remove("hidden"),T="ph",wt.textContent="Download PH Data",H.textContent="Do you want to download the pH data?"});X.addEventListener("click",()=>{O.classList.remove("hidden"),F.classList.remove("hidden"),T="humidity",wt.textContent="Download Humidity Data",H.textContent="Do you want to download the humidity data?"});A.addEventListener("click",()=>{T==="ph"?(A.disabled=!0,H.textContent="Mengunduh data pH...",setTimeout(async()=>{await Bt()},4e3),setTimeout(()=>{A.disabled=!1,H.textContent="Data pH berhasil diunduh."},1500)):T==="humidity"&&(A.disabled=!0,H.textContent="Mengunduh data kelembapan...",setTimeout(async()=>{await Et()},4e3),setTimeout(()=>{A.disabled=!1,H.textContent="Data humidity berhasil diunduh."},1500)),setTimeout(()=>{O.classList.add("hidden"),F.classList.add("hidden"),T=null},5e3)});G.addEventListener("click",()=>{O.classList.add("hidden"),F.classList.add("hidden"),T=null});bt.addEventListener("click",()=>{Y.classList.add("hidden"),K.classList.add("hidden")});window.addEventListener("click",function(t){!O.classList.contains("hidden")&&!F.classList.contains("hidden")?!Zt.contains(t.target)&&t.target!==A&&t.target!==G&&t.target!==Q&&t.target!==X&&(O.classList.add("hidden"),F.classList.add("hidden"),T=null):!Y.classList.contains("hidden")&&!K.classList.contains("hidden")&&!Xt.contains(t.target)&&t.target!==A&&t.target!==yt&&t.target!==bt&&t.target!==G&&t.target!==Q&&t.target!==X&&(Y.classList.add("hidden"),K.classList.add("hidden"))});flushButton.addEventListener("click",()=>{Ot("Flush Confirmation","Are you sure you want to flush the pump?")});function St(){const t=moment(),o=t.hour(),s=t.minute(),a=t.second(),e=t.format("HH : mm : ss"),n=t.format("ddd, D MMMM YYYY");document.getElementById("clock").textContent=e,document.getElementById("date").textContent=n;let i;o<7||o===7&&s===0&&a===0?i=moment().hour(7).minute(0).second(0):i=moment().add(1,"days").hour(7).minute(0).second(0);const r=moment.duration(i.diff(t)),d=String(r.hours()).padStart(2,"0"),l=String(r.minutes()).padStart(2,"0"),u=String(r.seconds()).padStart(2,"0"),p=`${d}`,m=`${l}`,g=`${u}`;document.getElementById("countdownHour").textContent=p,document.getElementById("countdownMinute").textContent=m,document.getElementById("countdownSecond").textContent=g}setInterval(St,1e3);St();
