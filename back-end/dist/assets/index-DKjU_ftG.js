(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const i of e.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function s(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(t){if(t.ep)return;t.ep=!0;const e=s(t);fetch(t.href,e)}})();const U="SensorMonitorDB",V=1,b="humidityUpdates",w="phUpdates";let p;function _(){return new Promise((n,o)=>{const s=indexedDB.open(U,V);s.onerror=a=>{console.error("Error opening IndexedDB:",a.target.errorCode),o(a.target.errorCode)},s.onsuccess=a=>{p=a.target.result,console.log("IndexedDB opened successfully"),n(p)},s.onupgradeneeded=a=>{const t=a.target.result;if(!t.objectStoreNames.contains(w)){const e=t.createObjectStore(w,{keyPath:"id",autoIncrement:!0});e.createIndex("timestampCloudReceived","timestampCloudReceived",{unique:!1}),e.createIndex("timestampBrowserReceived","timestampBrowserReceived",{unique:!1}),console.log(`Object store '${w}' created.`)}if(!t.objectStoreNames.contains(b)){const e=t.createObjectStore(b,{keyPath:"id",autoIncrement:!0});e.createIndex("timestampCloudReceived","timestampCloudReceived",{unique:!1}),e.createIndex("timestampBrowserReceived","timestampBrowserReceived",{unique:!1}),console.log(`Object store '${b}' created.`)}}})}function Y(n){if(!p){console.warn("IndexedDB not open. Cannot save pH data.");return}const a=p.transaction([w],"readwrite").objectStore(w).add(n);a.onsuccess=()=>{},a.onerror=t=>{console.error("Error saving pH data to IndexedDB:",t.target.errorCode)}}function K(n){if(!p){console.warn("IndexedDB not open. Cannot save humidity data.");return}const a=p.transaction([b],"readwrite").objectStore(b).add(n);a.onsuccess=()=>{},a.onerror=t=>{console.error("Error saving humidity data to IndexedDB:",t.target.errorCode)}}function N(n=10){return new Promise((o,s)=>{if(!p){console.warn("IndexedDB not open. Cannot get data."),o([]);return}const e=p.transaction([b],"readonly").objectStore(b).openCursor(null,"prev"),i=[];e.onsuccess=r=>{const c=r.target.result;c&&i.length<n?(i.push(c.value),c.continue()):o(i)},e.onerror=r=>{console.error("Error getting data from IndexedDB:",r.target.errorCode),s(r.target.errorCode)}})}function F(n=10){return new Promise((o,s)=>{if(!p){console.warn("IndexedDB not open. Cannot get data."),o([]);return}const e=p.transaction([w],"readonly").objectStore(w).openCursor(null,"prev"),i=[];e.onsuccess=r=>{const c=r.target.result;c&&i.length<n?(i.push(c.value),c.continue()):o(i)},e.onerror=r=>{console.error("Error getting data from IndexedDB:",r.target.errorCode),s(r.target.errorCode)}})}const X="a2spluztzgsdhl-ats.iot.ap-southeast-1.amazonaws.com",O="ap-southeast-1",G="ap-southeast-1:e9f502ea-58c5-459a-bfa3-3ce6e1fc9bff";AWS.config.region=O;AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:G});let v;const Q=async()=>{try{await new Promise((o,s)=>{AWS.config.credentials.get(a=>{a?s(a):o()})}),console.log("âœ… Cognito Credentials loaded.");const n=J.getSignedUrl(X,O,AWS.config.credentials.accessKeyId,AWS.config.credentials.secretAccessKey,AWS.config.credentials.sessionToken);v=mqtt.connect(n,{reconnectPeriod:5e3,clientId:"webclient_"+Math.floor(Math.random()*1e4),protocol:"wss",clean:!0}),v.on("connect",()=>{console.log("âœ… MQTT connected")}),v.on("error",o=>{console.error("âŒ MQTT Error:",o)})}catch(n){console.error("âŒ Gagal load Cognito credentials:",n)}};window.nyalakanPompa=()=>{if(!v||!v.connected){console.error("ðŸš« MQTT belum terkoneksi. Tidak bisa publish.");return}const n=moment().format("YYYY-MM-DD HH:mm:ss"),o=document.getElementById("flushButton");o.classList.add("opacity-80"),o.disabled=!0,o.textContent="Sending ...",setTimeout(()=>{o.textContent="Flushing ..."},2e3),setTimeout(()=>{o.classList.remove("opacity-80"),o.disabled=!1,o.textContent="Flush"},3e4);const s=JSON.stringify({action:"nyala"});v.publish("device/pompa",s,{qos:1},a=>{a?console.error("ðŸš« Publish error:",a):console.log("ðŸ“¤ Pompa nyala command dikirim pada",n)})};const J={getSignedUrl:function(n,o,s,a,t){const e=new Date,i=e.toISOString().slice(0,10).replace(/-/g,""),r=e.toISOString().replace(/[:-]|\.\d{3}/g,""),c="iotdevicegateway",l="AWS4-HMAC-SHA256",u="GET",m="/mqtt",y=i+"/"+o+"/"+c+"/aws4_request",C="X-Amz-Algorithm="+l+"&X-Amz-Credential="+encodeURIComponent(s+"/"+y)+"&X-Amz-Date="+r+"&X-Amz-SignedHeaders=host",T="host:"+n+`
`,H=AWS.util.crypto.sha256("","hex"),A=u+`
`+m+`
`+C+`
`+T+`
host
`+H,I=l+`
`+r+`
`+y+`
`+AWS.util.crypto.sha256(A,"hex"),D=AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac("AWS4"+a,i,"buffer"),o,"buffer"),c,"buffer"),"aws4_request","buffer"),B=AWS.util.crypto.hmac(D,I,"hex");let E="wss://"+n+m+"?"+C+"&X-Amz-Signature="+B;return t&&(E+="&X-Amz-Security-Token="+encodeURIComponent(t)),E}};let f;const q=()=>{if(f&&f.readyState!==WebSocket.CLOSED&&f.readyState!==WebSocket.CLOSING){console.log("WebSocket sudah aktif. Tidak membuat koneksi baru.");return}const n="wss://chili-monitor.andzuru.space";f=new WebSocket(n),f.onopen=()=>{console.log("âœ… WebSocket connected to",n)},f.onmessage=o=>{try{const s=JSON.parse(o.data);console.log("ðŸ“¨ Data diterima:",s);const{topic:a,data:t,chartData:e,timestamp:i}=s,{ph:r,humidity:c}=e;let l=null;if(r&&Array.isArray(r.timestamps)&&r.timestamps.length>0){let d=r.timestamps[r.timestamps.length-1];typeof d=="string"&&d?l=new Date(d).toISOString():typeof d=="number"&&!isNaN(d)&&(d<1e10&&(d*=1e3),l=new Date(d).toISOString())}let u=null;if(c&&Array.isArray(c.timestamps)&&c.timestamps.length>0){let d=c.timestamps[c.timestamps.length-1];typeof d=="string"&&d?u=new Date(d).toISOString():typeof d=="number"&&!isNaN(d)&&(d<1e10&&(d*=1e3),u=new Date(d).toISOString())}const m=new Date(Date.now()+7*60*60*1e3),y=m.toISOString(),C=m-Number(i),T={timestampCloudReceived:i,timestampBrowserReceived:y,latency:parseFloat(C),humidityValue:parseFloat((t==null?void 0:t.Kelembapan)??null),humidityDataReceivedAt:u};let H=null;(t==null?void 0:t.Ph)===void 0||(t==null?void 0:t.Ph)===null?console.log("PH tidak ada pembaharuan data"):(t==null?void 0:t.Ph)!==void 0&&(t==null?void 0:t.Ph)!==null&&(H={timestampCloudReceived:i,timestampBrowserReceived:y,latency:parseFloat(C),phValue:parseFloat(t.Ph),phDataReceivedAt:l}),K(T),Y(H);const A=parseFloat((t==null?void 0:t.Ph)??null),I=parseFloat((t==null?void 0:t.Kelembapan)??null),D=!isNaN(A)&&typeof A=="number"?A.toFixed(2):"N/A",B=!isNaN(I)&&typeof I=="number"?I.toFixed(2):"N/A",E=document.getElementById("phValue"),L=document.getElementById("humidityValue"),k=document.getElementById("ground-good-status"),W=document.getElementById("ground-poor-status");if(D>8.5||D<5.5||B>90||B<10?(k.classList.add("hidden"),W.classList.remove("hidden")):(W.classList.add("hidden"),k.classList.remove("hidden")),E&&(E.textContent=D),L&&(L.textContent=B),e){if(r&&Array.isArray(r.timestamps)&&Array.isArray(r.values)){const d=r.timestamps.map(g=>Number(g)),x=r.values.map(g=>Number(g));console.log("ðŸ“Š pH timestamps:",d),console.log("ðŸ“Š pH values:",x),F(1).then(g=>{g&&g.length>0?setTimeout(Z,200):tt(d,x)})}if(c&&Array.isArray(c.timestamps)&&Array.isArray(c.values)){const d=c.timestamps.map(g=>Number(g)),x=c.values.map(g=>Number(g));console.log("ðŸ’§ Humidity timestamps:",d),console.log("ðŸ’§ Humidity values:",x),N(1).then(g=>{g&&g.length>0?setTimeout(nt,200):at(d,x)})}}}catch(s){console.error("âŒ Error parsing WebSocket message:",s)}},f.onerror=o=>{console.error("âš ï¸ WebSocket error:",o)},f.onclose=o=>{console.warn(`âš ï¸ WebSocket disconnected. Code: ${o.code}, Reason: ${o.reason}`),setTimeout(()=>{console.log("ðŸ” Mencoba reconnect WebSocket..."),q()},5e3)}};document.addEventListener("DOMContentLoaded",()=>{q(),Q(),_().then(()=>{}).catch(n=>console.error("Failed to open IndexedDB:",n))});async function Z(){const n=await F();if(!n||n.length===0){h.data.datasets[0].data=[],h.data.labels=[],h.update();return}const o=n.slice().reverse(),s=o.map(t=>{const e=new Date(t.phDataReceivedAt),i=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${i}-${r}-${c} ${l}:${u}:${m}`}),a=o.map(t=>t.phValue);h.data.datasets[0].data=a,h.data.labels=s,h.update()}function tt(n,o){function s(t){const e=new Date(t),i=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${i}-${r}-${c} ${l}:${u}:${m}`}const a=n.map(t=>s(t));h.data.datasets[0].data=o,h.data.labels=a,h.update()}const et={labels:[],datasets:[{label:"Soil pH",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2}]},ot={type:"bar",data:et,options:{scales:{y:{beginAtZero:!0}}}},h=new Chart(document.getElementById("myChart1"),ot);async function nt(){const n=await N();if(!n||n.length===0){S.data.datasets[0].data=[],S.data.labels=[],S.update();return}const o=n.slice().reverse(),s=o.map(t=>{const e=new Date(t.humidityDataReceivedAt),i=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${i}-${r}-${c} ${l}:${u}:${m}`}),a=o.map(t=>t.humidityValue);S.data.datasets[0].data=a,S.data.labels=s,S.update()}function at(n,o){function s(t){const e=new Date(t),i=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${i}-${r}-${c} ${l}:${u}:${m}`}const a=n.map(t=>s(t));console.log(a),S.data.datasets[0].data=o,S.data.labels=a,S.update()}const st={labels:[],datasets:[{label:"Soil Moisture",data:[],borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:2}]},rt={type:"bar",data:st,options:{scales:{y:{beginAtZero:!0}}}},S=new Chart(document.getElementById("myChart"),rt),P=document.querySelector("#hamburger"),M=document.querySelector("#nav-menu");P.addEventListener("click",function(){P.classList.toggle("hamburger-active"),M.classList.toggle("hidden")});window.addEventListener("click",function(n){n.target!=P&&n.target!=M&&(P.classList.remove("hamburger-active"),M.classList.add("hidden"))});const R=document.getElementById("modal-container-1"),$=document.getElementById("modal-container-2"),ct=document.getElementById("modal-main"),j=document.getElementById("info-button"),it=document.getElementById("close-modal");j.addEventListener("click",()=>{R.classList.remove("hidden"),$.classList.remove("hidden")});it.addEventListener("click",()=>{R.classList.add("hidden"),$.classList.add("hidden")});window.addEventListener("click",function(n){!ct.contains(n.target)&&!j.contains(n.target)&&(R.classList.add("hidden"),$.classList.add("hidden"))});function z(){const n=moment(),o=n.hour(),s=n.minute(),a=n.second(),t=n.format("HH : mm : ss");document.getElementById("clock").textContent=t;let e;o<7||o===7&&s===0&&a===0?e=moment().hour(7).minute(0).second(0):e=moment().add(1,"days").hour(7).minute(0).second(0),o===7&&s===0&&a===0&&nyalakanPompa();const i=moment.duration(e.diff(n)),r=String(i.hours()).padStart(2,"0"),c=String(i.minutes()).padStart(2,"0"),l=String(i.seconds()).padStart(2,"0"),u=`${r}`,m=`${c}`,y=`${l}`;document.getElementById("countdownHour").textContent=u,document.getElementById("countdownMinute").textContent=m,document.getElementById("countdownSecond").textContent=y}setInterval(z,1e3);z();
