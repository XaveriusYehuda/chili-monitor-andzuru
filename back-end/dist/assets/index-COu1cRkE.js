(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const c of e.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function s(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(t){if(t.ep)return;t.ep=!0;const e=s(t);fetch(t.href,e)}})();const K="SensorMonitorDB",U=1,S="humidityUpdates",y="phUpdates";let g;function V(){return new Promise((o,n)=>{const s=indexedDB.open(K,U);s.onerror=a=>{console.error("Error opening IndexedDB:",a.target.errorCode),n(a.target.errorCode)},s.onsuccess=a=>{g=a.target.result,console.log("IndexedDB opened successfully"),o(g)},s.onupgradeneeded=a=>{const t=a.target.result;if(!t.objectStoreNames.contains(y)){const e=t.createObjectStore(y,{keyPath:"id",autoIncrement:!0});e.createIndex("timestampCloudReceived","timestampCloudReceived",{unique:!1}),e.createIndex("timestampBrowserReceived","timestampBrowserReceived",{unique:!1}),console.log(`Object store '${y}' created.`)}if(!t.objectStoreNames.contains(S)){const e=t.createObjectStore(S,{keyPath:"id",autoIncrement:!0});e.createIndex("timestampCloudReceived","timestampCloudReceived",{unique:!1}),e.createIndex("timestampBrowserReceived","timestampBrowserReceived",{unique:!1}),console.log(`Object store '${S}' created.`)}}})}function _(o){if(!g){console.warn("IndexedDB not open. Cannot save pH data.");return}if(!o||typeof o!="object"){console.warn("Invalid pH data. Not saving to IndexedDB.");return}"id"in o&&delete o.id;const a=g.transaction([y],"readwrite").objectStore(y).add(o);a.onsuccess=()=>{},a.onerror=t=>{console.error("Error saving pH data to IndexedDB:",t.target.errorCode)}}function Y(o){if(!g){console.warn("IndexedDB not open. Cannot save humidity data.");return}const a=g.transaction([S],"readwrite").objectStore(S).add(o);a.onsuccess=()=>{},a.onerror=t=>{console.error("Error saving humidity data to IndexedDB:",t.target.errorCode)}}function W(o=8){return new Promise((n,s)=>{if(!g){console.warn("IndexedDB not open. Cannot get data."),n([]);return}const e=g.transaction([S],"readonly").objectStore(S).openCursor(null,"prev"),c=[];e.onsuccess=r=>{const i=r.target.result;i&&c.length<o?(c.push(i.value),i.continue()):n(c)},e.onerror=r=>{console.error("Error getting data from IndexedDB:",r.target.errorCode),s(r.target.errorCode)}})}function F(o=8){return new Promise((n,s)=>{if(!g){console.warn("IndexedDB not open. Cannot get data."),n([]);return}const e=g.transaction([y],"readonly").objectStore(y).openCursor(null,"prev"),c=[];e.onsuccess=r=>{const i=r.target.result;i&&c.length<o?(c.push(i.value),i.continue()):n(c)},e.onerror=r=>{console.error("Error getting data from IndexedDB:",r.target.errorCode),s(r.target.errorCode)}})}const X="a2spluztzgsdhl-ats.iot.ap-southeast-1.amazonaws.com",O="ap-southeast-1",G="ap-southeast-1:e9f502ea-58c5-459a-bfa3-3ce6e1fc9bff";AWS.config.region=O;AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:G});let w;const Q=async()=>{try{await new Promise((n,s)=>{AWS.config.credentials.get(a=>{a?s(a):n()})}),console.log("✅ Cognito Credentials loaded.");const o=J.getSignedUrl(X,O,AWS.config.credentials.accessKeyId,AWS.config.credentials.secretAccessKey,AWS.config.credentials.sessionToken);w=mqtt.connect(o,{reconnectPeriod:5e3,clientId:"webclient_"+Math.floor(Math.random()*1e4),protocol:"wss",clean:!0}),w.on("connect",()=>{console.log("✅ MQTT connected")}),w.on("error",n=>{console.error("❌ MQTT Error:",n)})}catch(o){console.error("❌ Gagal load Cognito credentials:",o)}};window.nyalakanPompa=()=>{if(!w||!w.connected){console.error("🚫 MQTT belum terkoneksi. Tidak bisa publish.");return}const o=moment().format("YYYY-MM-DD HH:mm:ss"),n=document.getElementById("flushButton");n.classList.add("opacity-80"),n.disabled=!0,n.textContent="Sending ...",setTimeout(()=>{n.textContent="Flushing ..."},2e3),setTimeout(()=>{n.classList.remove("opacity-80"),n.disabled=!1,n.textContent="Flush"},3e4);const s=JSON.stringify({action:"nyala"});w.publish("device/pompa",s,{qos:1},a=>{a?console.error("🚫 Publish error:",a):console.log("📤 Pompa nyala command dikirim pada",o)})};const J={getSignedUrl:function(o,n,s,a,t){const e=new Date,c=e.toISOString().slice(0,10).replace(/-/g,""),r=e.toISOString().replace(/[:-]|\.\d{3}/g,""),i="iotdevicegateway",l="AWS4-HMAC-SHA256",u="GET",m="/mqtt",b=c+"/"+n+"/"+i+"/aws4_request",v="X-Amz-Algorithm="+l+"&X-Amz-Credential="+encodeURIComponent(s+"/"+b)+"&X-Amz-Date="+r+"&X-Amz-SignedHeaders=host",B="host:"+o+`
`,E=AWS.util.crypto.sha256("","hex"),N=u+`
`+m+`
`+v+`
`+B+`
host
`+E,D=l+`
`+r+`
`+b+`
`+AWS.util.crypto.sha256(N,"hex"),C=AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac("AWS4"+a,c,"buffer"),n,"buffer"),i,"buffer"),"aws4_request","buffer"),x=AWS.util.crypto.hmac(C,D,"hex");let A="wss://"+o+m+"?"+v+"&X-Amz-Signature="+x;return t&&(A+="&X-Amz-Security-Token="+encodeURIComponent(t)),A}};let f;const q=()=>{if(f&&f.readyState!==WebSocket.CLOSED&&f.readyState!==WebSocket.CLOSING){console.log("WebSocket sudah aktif. Tidak membuat koneksi baru.");return}const o="wss://chili-monitor.andzuru.space";f=new WebSocket(o),f.onopen=async()=>{console.log("✅ WebSocket connected to",o),await T(),await L()},f.onmessage=n=>{try{const s=JSON.parse(n.data);console.log("📨 Data diterima:",s);const{topic:a,data:t,chartData:e,timestamp:c}=s,{ph:r,humidity:i}=e||{},l=parseFloat((t==null?void 0:t.Ph)??"NaN"),u=parseFloat((t==null?void 0:t.Kelembapan)??"NaN"),m=isNaN(l)?"N/A":l.toFixed(1),b=isNaN(u)?"N/A":u.toFixed(1),v=document.getElementById("phValue"),B=document.getElementById("humidityValue"),E=document.getElementById("ground-good-status"),N=document.getElementById("ground-poor-status");if(!isNaN(l)&&!isNaN(u)&&(l>8.5||l<5.5||u>90||u<10)?(E.classList.add("hidden"),N.classList.remove("hidden")):(N.classList.add("hidden"),E.classList.remove("hidden")),v&&(v.textContent=m),B&&(B.textContent=b),e){if(r&&Array.isArray(r.timestamps)&&Array.isArray(r.values)){const d=r.timestamps.map(Number),P=r.values.map(Number);navigator.onLine?F(1).then(I=>{I&&I.length>0?setTimeout(T,200):Z(d,P)}):T()}if(i&&Array.isArray(i.timestamps)&&Array.isArray(i.values)){const d=i.timestamps.map(Number),P=i.values.map(Number);navigator.onLine?W(1).then(I=>{I&&I.length>0?setTimeout(L,200):ot(d,P)}):L()}}let D=null;if(r&&Array.isArray(r.timestamps)&&r.timestamps.length>0){let d=r.timestamps[r.timestamps.length-1];typeof d=="string"&&d?D=new Date(d).toISOString():typeof d=="number"&&!isNaN(d)&&(d<1e10&&(d*=1e3),D=new Date(d).toISOString())}let C=null;if(i&&Array.isArray(i.timestamps)&&i.timestamps.length>0){let d=i.timestamps[i.timestamps.length-1];typeof d=="string"&&d?C=new Date(d).toISOString():typeof d=="number"&&!isNaN(d)&&(d<1e10&&(d*=1e3),C=new Date(d).toISOString())}const x=new Date(Date.now()+7*60*60*1e3),A=x.toISOString(),k=x-Number(c);if(t){if(t.Kelembapan!==void 0&&t.Kelembapan!==null&&!isNaN(parseFloat(t.Kelembapan))){const d={timestampCloudReceived:c,timestampBrowserReceived:A,latency:parseFloat(k),humidityValue:parseFloat(t.Kelembapan),humidityDataReceivedAt:C};Y(d)}else console.log("Kelembapan tidak ada pembaharuan data");if(t.Ph!==void 0&&t.Ph!==null&&!isNaN(parseFloat(t.Ph))){const d={timestampCloudReceived:c,timestampBrowserReceived:A,latency:parseFloat(k),phValue:parseFloat(t.Ph),phDataReceivedAt:D};_(d)}else console.log("PH tidak ada pembaharuan data")}}catch(s){console.error("❌ Error parsing WebSocket message:",s)}},f.onerror=n=>{console.error("⚠️ WebSocket error:",n)},f.onclose=n=>{console.warn(`⚠️ WebSocket disconnected. Code: ${n.code}, Reason: ${n.reason}`),setTimeout(()=>{console.log("🔁 Mencoba reconnect WebSocket..."),q()},5e3)}};document.addEventListener("DOMContentLoaded",()=>{q(),Q(),V().then(()=>{}).catch(o=>console.error("Failed to open IndexedDB:",o))});async function T(){const o=await F();if(!o||o.length===0){p.data.datasets[0].data=[],p.data.labels=[],p.update();return}const n=o.slice().reverse(),s=n.map(t=>{const e=new Date(t.phDataReceivedAt),c=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${c}-${r}-${i} ${l}:${u}:${m}`}),a=n.map(t=>t.phValue);p.data.datasets[0].data=a,p.data.labels=s,p.update()}function Z(o,n){function s(t){const e=new Date(t),c=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${c}-${r}-${i} ${l}:${u}:${m}`}const a=o.map(t=>s(t));p.data.datasets[0].data=n,p.data.labels=a,p.update()}const tt={labels:[],datasets:[{label:"Soil pH",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2}]},et={type:"line",data:tt,options:{scales:{y:{beginAtZero:!1}}}},p=new Chart(document.getElementById("myChart1"),et);async function L(){const o=await W();if(!o||o.length===0){h.data.datasets[0].data=[],h.data.labels=[],h.update();return}const n=o.slice().reverse(),s=n.map(t=>{const e=new Date(t.humidityDataReceivedAt),c=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${c}-${r}-${i} ${l}:${u}:${m}`}),a=n.map(t=>t.humidityValue);h.data.datasets[0].data=a,h.data.labels=s,h.update()}function ot(o,n){function s(t){const e=new Date(t),c=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${c}-${r}-${i} ${l}:${u}:${m}`}const a=o.map(t=>s(t));console.log(a),h.data.datasets[0].data=n,h.data.labels=a,h.update()}const nt={labels:[],datasets:[{label:"Soil Moisture",data:[],borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:2}]},at={type:"line",data:nt,options:{scales:{y:{beginAtZero:!1}}}},h=new Chart(document.getElementById("myChart"),at),H=document.querySelector("#hamburger"),M=document.querySelector("#nav-menu");H.addEventListener("click",function(){H.classList.toggle("hamburger-active"),M.classList.toggle("hidden")});window.addEventListener("click",function(o){o.target!=H&&o.target!=M&&(H.classList.remove("hamburger-active"),M.classList.add("hidden"))});const R=document.getElementById("modal-container-1"),$=document.getElementById("modal-container-2"),st=document.getElementById("modal-main"),j=document.getElementById("info-button"),rt=document.getElementById("close-modal");j.addEventListener("click",()=>{R.classList.remove("hidden"),$.classList.remove("hidden")});rt.addEventListener("click",()=>{R.classList.add("hidden"),$.classList.add("hidden")});window.addEventListener("click",function(o){!st.contains(o.target)&&!j.contains(o.target)&&(R.classList.add("hidden"),$.classList.add("hidden"))});function z(){const o=moment(),n=o.hour(),s=o.minute(),a=o.second(),t=o.format("HH : mm : ss");document.getElementById("clock").textContent=t;let e;n<7||n===7&&s===0&&a===0?e=moment().hour(7).minute(0).second(0):e=moment().add(1,"days").hour(7).minute(0).second(0),n===7&&s===0&&a===0&&nyalakanPompa();const c=moment.duration(e.diff(o)),r=String(c.hours()).padStart(2,"0"),i=String(c.minutes()).padStart(2,"0"),l=String(c.seconds()).padStart(2,"0"),u=`${r}`,m=`${i}`,b=`${l}`;document.getElementById("countdownHour").textContent=u,document.getElementById("countdownMinute").textContent=m,document.getElementById("countdownSecond").textContent=b}setInterval(z,1e3);z();
