(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const r of e.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function s(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(t){if(t.ep)return;t.ep=!0;const e=s(t);fetch(t.href,e)}})();const P="a2spluztzgsdhl-ats.iot.ap-southeast-1.amazonaws.com",k="ap-southeast-1",L="ap-southeast-1:e9f502ea-58c5-459a-bfa3-3ce6e1fc9bff";AWS.config.region=k;AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:L});let b;const M=async()=>{try{await new Promise((o,s)=>{AWS.config.credentials.get(a=>{a?s(a):o()})}),console.log("✅ Cognito Credentials loaded.");const n=$.getSignedUrl(P,k,AWS.config.credentials.accessKeyId,AWS.config.credentials.secretAccessKey,AWS.config.credentials.sessionToken);b=mqtt.connect(n,{reconnectPeriod:5e3,clientId:"webclient_"+Math.floor(Math.random()*1e4),protocol:"wss",clean:!0}),b.on("connect",()=>{console.log("✅ MQTT connected")}),b.on("error",o=>{console.error("❌ MQTT Error:",o)})}catch(n){console.error("❌ Gagal load Cognito credentials:",n)}};window.nyalakanPompa=()=>{if(!b||!b.connected){console.error("🚫 MQTT belum terkoneksi. Tidak bisa publish.");return}const n=JSON.stringify({action:"nyala"});b.publish("device/pompa",n,{qos:1},o=>{o?console.error("🚫 Publish error:",o):console.log("📤 Pompa nyala command terkirim.")})};const $={getSignedUrl:function(n,o,s,a,t){const e=new Date,r=e.toISOString().slice(0,10).replace(/-/g,""),d=e.toISOString().replace(/[:-]|\.\d{3}/g,""),i="iotdevicegateway",c="AWS4-HMAC-SHA256",u="GET",l="/mqtt",p=r+"/"+o+"/"+i+"/aws4_request",A="X-Amz-Algorithm="+c+"&X-Amz-Credential="+encodeURIComponent(s+"/"+p)+"&X-Amz-Date="+d+"&X-Amz-SignedHeaders=host",y="host:"+n+`
`,h=AWS.util.crypto.sha256("","hex"),f=u+`
`+l+`
`+A+`
`+y+`
host
`+h,S=c+`
`+d+`
`+p+`
`+AWS.util.crypto.sha256(f,"hex"),m=AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac("AWS4"+a,r,"buffer"),o,"buffer"),i,"buffer"),"aws4_request","buffer"),T=AWS.util.crypto.hmac(m,S,"hex");let I="wss://"+n+l+"?"+A+"&X-Amz-Signature="+T;return t&&(I+="&X-Amz-Security-Token="+encodeURIComponent(t)),I}};let g;const v=()=>{if(g&&g.readyState!==WebSocket.CLOSED&&g.readyState!==WebSocket.CLOSING){console.log("WebSocket sudah aktif. Tidak membuat koneksi baru.");return}const n="wss://chili-api-server.andzuru.space";g=new WebSocket(n),g.onopen=()=>{console.log("✅ WebSocket connected to",n)},g.onmessage=o=>{try{const s=JSON.parse(o.data);console.log("📨 Data diterima:",s);const{topic:a,data:t,chartData:e}=s,r=(t==null?void 0:t.Ph)??null,d=(t==null?void 0:t.Kelembapan)??null,i=typeof r=="number"?r.toFixed(2):"N/A",c=typeof d=="number"?d.toFixed(2):"N/A",u=document.getElementById("phValue"),l=document.getElementById("humidityValue"),p=document.getElementById("ground-good-status"),A=document.getElementById("ground-poor-status");if(c<15&&nyalakanPompa(),i>8.5||i<5.5||c>80||c<20?(p.classList.add("hidden"),A.classList.remove("hidden")):(A.classList.add("hidden"),p.classList.remove("hidden")),u&&(u.textContent=i),l&&(l.textContent=c),e){const{ph:y,humidity:h}=e;if(y&&Array.isArray(y.timestamps)&&Array.isArray(y.values)){const f=y.timestamps.map(m=>Number(m)),S=y.values.map(m=>Number(m));console.log("📊 pH timestamps:",f),console.log("📊 pH values:",S),x(f,S)}if(h&&Array.isArray(h.timestamps)&&Array.isArray(h.values)){const f=h.timestamps.map(m=>Number(m)),S=h.values.map(m=>Number(m));console.log("💧 Humidity timestamps:",f),console.log("💧 Humidity values:",S),N(f,S)}}}catch(s){console.error("❌ Error parsing WebSocket message:",s)}},g.onerror=o=>{console.error("⚠️ WebSocket error:",o)},g.onclose=o=>{console.warn(`⚠️ WebSocket disconnected. Code: ${o.code}, Reason: ${o.reason}`),setTimeout(()=>{console.log("🔁 Mencoba reconnect WebSocket..."),v()},5e3)}};document.addEventListener("DOMContentLoaded",()=>{v(),M(),document.getElementById("phValue"),document.getElementById("humidityValue")});function x(n,o){function s(t){const e=new Date(t),r=e.getFullYear(),d=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),c=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0");return`${r}-${d}-${i} ${c}:${u}:${l}`}const a=n.map(t=>s(t));console.log(a),w.data.datasets[0].data=o,w.data.labels=a,w.update()}const O={labels:[],datasets:[{label:"Soil pH",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2}]},B={type:"bar",data:O,options:{scales:{y:{beginAtZero:!0}}}},w=new Chart(document.getElementById("myChart1"),B);function N(n,o){function s(t){const e=new Date(t),r=e.getFullYear(),d=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),c=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0");return`${r}-${d}-${i} ${c}:${u}:${l}`}const a=n.map(t=>s(t));console.log(a),C.data.datasets[0].data=o,C.data.labels=a,C.update()}const q={labels:[],datasets:[{label:"Soil Moisture",data:[],borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:2}]},z={type:"bar",data:q,options:{scales:{y:{beginAtZero:!0}}}},C=new Chart(document.getElementById("myChart"),z),W=document.querySelector("#hamburger"),H=document.querySelector("#nav-menu");W.addEventListener("click",function(){W.classList.toggle("hamburger-active"),H.classList.toggle("hidden")});window.addEventListener("click",function(n){n.target!=W&&n.target!=H&&(hamburger.classList.remove("hamburger-active"),H.classList.add("hidden"))});function E(){const n=moment(),o=n.hour(),s=n.minute(),a=n.second(),t=n.format("HH : mm : ss");document.getElementById("clock").textContent=t;let e;o<7||o===7&&s===0&&a===0?e=moment().hour(7).minute(0).second(0):e=moment().add(1,"days").hour(7).minute(0).second(0),o===7&&s===0&&a===0&&nyalakanPompa();const r=moment.duration(e.diff(n)),d=String(r.hours()).padStart(2,"0"),i=String(r.minutes()).padStart(2,"0"),c=String(r.seconds()).padStart(2,"0"),u=`${d}`,l=`${i}`,p=`${c}`;document.getElementById("countdownHour").textContent=u,document.getElementById("countdownMinute").textContent=l,document.getElementById("countdownSecond").textContent=p}setInterval(E,1e3);E();
