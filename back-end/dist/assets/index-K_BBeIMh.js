(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const c of e.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function a(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(t){if(t.ep)return;t.ep=!0;const e=a(t);fetch(t.href,e)}})();const P="a2spluztzgsdhl-ats.iot.ap-southeast-1.amazonaws.com",H="ap-southeast-1",x="ap-southeast-1:e9f502ea-58c5-459a-bfa3-3ce6e1fc9bff";AWS.config.region=H;AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:x});let b;const $=async()=>{try{await new Promise((o,a)=>{AWS.config.credentials.get(s=>{s?a(s):o()})}),console.log("✅ Cognito Credentials loaded.");const n=N.getSignedUrl(P,H,AWS.config.credentials.accessKeyId,AWS.config.credentials.secretAccessKey,AWS.config.credentials.sessionToken);b=mqtt.connect(n,{reconnectPeriod:5e3,clientId:"webclient_"+Math.floor(Math.random()*1e4),protocol:"wss",clean:!0}),b.on("connect",()=>{console.log("✅ MQTT connected")}),b.on("error",o=>{console.error("❌ MQTT Error:",o)})}catch(n){console.error("❌ Gagal load Cognito credentials:",n)}};window.nyalakanPompa=()=>{if(!b||!b.connected){console.error("🚫 MQTT belum terkoneksi. Tidak bisa publish.");return}const n=moment().format("YYYY-MM-DD HH:mm:ss"),o=document.getElementById("flushButton");o.classList.add("opacity-80"),o.disabled=!0,o.textContent="Sending ...",setTimeout(()=>{o.textContent="Flushing ..."},2e3),setTimeout(()=>{o.classList.remove("opacity-80"),o.disabled=!1,o.textContent="Flush"},3e4);const a=JSON.stringify({action:"nyala"});b.publish("device/pompa",a,{qos:1},s=>{s?console.error("🚫 Publish error:",s):console.log("📤 Pompa nyala command dikirim pada",n)})};const N={getSignedUrl:function(n,o,a,s,t){const e=new Date,c=e.toISOString().slice(0,10).replace(/-/g,""),r=e.toISOString().replace(/[:-]|\.\d{3}/g,""),i="iotdevicegateway",d="AWS4-HMAC-SHA256",u="GET",l="/mqtt",p=c+"/"+o+"/"+i+"/aws4_request",w="X-Amz-Algorithm="+d+"&X-Amz-Credential="+encodeURIComponent(a+"/"+p)+"&X-Amz-Date="+r+"&X-Amz-SignedHeaders=host",y="host:"+n+`
`,h=AWS.util.crypto.sha256("","hex"),f=u+`
`+l+`
`+w+`
`+y+`
host
`+h,S=d+`
`+r+`
`+p+`
`+AWS.util.crypto.sha256(f,"hex"),m=AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac("AWS4"+s,c,"buffer"),o,"buffer"),i,"buffer"),"aws4_request","buffer"),M=AWS.util.crypto.hmac(m,S,"hex");let v="wss://"+n+l+"?"+w+"&X-Amz-Signature="+M;return t&&(v+="&X-Amz-Security-Token="+encodeURIComponent(t)),v}};let g;const k=()=>{if(g&&g.readyState!==WebSocket.CLOSED&&g.readyState!==WebSocket.CLOSING){console.log("WebSocket sudah aktif. Tidak membuat koneksi baru.");return}const n="wss://chili-monitor.andzuru.space";g=new WebSocket(n),g.onopen=()=>{console.log("✅ WebSocket connected to",n)},g.onmessage=o=>{try{const a=JSON.parse(o.data);console.log("📨 Data diterima:",a);const{topic:s,data:t,chartData:e}=a,c=parseFloat((t==null?void 0:t.Ph)??null),r=parseFloat((t==null?void 0:t.Kelembapan)??null),i=!isNaN(c)&&typeof c=="number"?c.toFixed(2):"N/A",d=!isNaN(r)&&typeof r=="number"?r.toFixed(2):"N/A",u=document.getElementById("phValue"),l=document.getElementById("humidityValue"),p=document.getElementById("ground-good-status"),w=document.getElementById("ground-poor-status");if(i>8.5||i<5.5||d>90||d<10?(p.classList.add("hidden"),w.classList.remove("hidden")):(w.classList.add("hidden"),p.classList.remove("hidden")),u&&(u.textContent=i),l&&(l.textContent=d),e){const{ph:y,humidity:h}=e;if(y&&Array.isArray(y.timestamps)&&Array.isArray(y.values)){const f=y.timestamps.map(m=>Number(m)),S=y.values.map(m=>Number(m));console.log("📊 pH timestamps:",f),console.log("📊 pH values:",S),O(f,S)}if(h&&Array.isArray(h.timestamps)&&Array.isArray(h.values)){const f=h.timestamps.map(m=>Number(m)),S=h.values.map(m=>Number(m));console.log("💧 Humidity timestamps:",f),console.log("💧 Humidity values:",S),z(f,S)}}}catch(a){console.error("❌ Error parsing WebSocket message:",a)}},g.onerror=o=>{console.error("⚠️ WebSocket error:",o)},g.onclose=o=>{console.warn(`⚠️ WebSocket disconnected. Code: ${o.code}, Reason: ${o.reason}`),setTimeout(()=>{console.log("🔁 Mencoba reconnect WebSocket..."),k()},5e3)}};document.addEventListener("DOMContentLoaded",()=>{k(),$(),document.getElementById("phValue"),document.getElementById("humidityValue")});function O(n,o){function a(t){const e=new Date(t),c=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),d=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0");return`${c}-${r}-${i} ${d}:${u}:${l}`}const s=n.map(t=>a(t));console.log(s),C.data.datasets[0].data=o,C.data.labels=s,C.update()}const D={labels:[],datasets:[{label:"Soil pH",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2}]},q={type:"bar",data:D,options:{scales:{y:{beginAtZero:!0}}}},C=new Chart(document.getElementById("myChart1"),q);function z(n,o){function a(t){const e=new Date(t),c=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),d=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0");return`${c}-${r}-${i} ${d}:${u}:${l}`}const s=n.map(t=>a(t));console.log(s),E.data.datasets[0].data=o,E.data.labels=s,E.update()}const F={labels:[],datasets:[{label:"Soil Moisture",data:[],borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:2}]},U={type:"bar",data:F,options:{scales:{y:{beginAtZero:!0}}}},E=new Chart(document.getElementById("myChart"),U),A=document.querySelector("#hamburger"),I=document.querySelector("#nav-menu");A.addEventListener("click",function(){A.classList.toggle("hamburger-active"),I.classList.toggle("hidden")});window.addEventListener("click",function(n){n.target!=A&&n.target!=I&&(A.classList.remove("hamburger-active"),I.classList.add("hidden"))});const L=document.getElementById("modal-container-1"),W=document.getElementById("modal-container-2"),V=document.getElementById("modal-main"),T=document.getElementById("info-button"),R=document.getElementById("close-modal");T.addEventListener("click",()=>{L.classList.remove("hidden"),W.classList.remove("hidden")});R.addEventListener("click",()=>{L.classList.add("hidden"),W.classList.add("hidden")});window.addEventListener("click",function(n){!V.contains(n.target)&&!T.contains(n.target)&&(L.classList.add("hidden"),W.classList.add("hidden"))});function B(){const n=moment(),o=n.hour(),a=n.minute(),s=n.second(),t=n.format("HH : mm : ss");document.getElementById("clock").textContent=t;let e;o<7||o===7&&a===0&&s===0?e=moment().hour(7).minute(0).second(0):e=moment().add(1,"days").hour(7).minute(0).second(0),o===7&&a===0&&s===0&&nyalakanPompa();const c=moment.duration(e.diff(n)),r=String(c.hours()).padStart(2,"0"),i=String(c.minutes()).padStart(2,"0"),d=String(c.seconds()).padStart(2,"0"),u=`${r}`,l=`${i}`,p=`${d}`;document.getElementById("countdownHour").textContent=u,document.getElementById("countdownMinute").textContent=l,document.getElementById("countdownSecond").textContent=p}setInterval(B,1e3);B();
