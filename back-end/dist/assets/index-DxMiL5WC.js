(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const r of e.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function c(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(t){if(t.ep)return;t.ep=!0;const e=c(t);fetch(t.href,e)}})();const V="SensorMonitorDB",_=1,h="humidityUpdates",S="phUpdates";let g;function Y(){return new Promise((o,n)=>{const c=indexedDB.open(V,_);c.onerror=a=>{console.error("Error opening IndexedDB:",a.target.errorCode),n(a.target.errorCode)},c.onsuccess=a=>{g=a.target.result,console.log("IndexedDB opened successfully"),o(g)},c.onupgradeneeded=a=>{const t=a.target.result;t.objectStoreNames.contains(S)||(t.createObjectStore(S,{keyPath:"id",autoIncrement:!0}),console.log(`Object store '${S}' created.`)),t.objectStoreNames.contains(h)||(t.createObjectStore(h,{keyPath:"id",autoIncrement:!0}),console.log(`Object store '${h}' created.`))}})}function J(o){if(!g){console.warn("IndexedDB not open. Cannot save pH data.");return}if(!o||typeof o!="object"){console.warn("Invalid pH data. Not saving to IndexedDB.");return}"id"in o&&delete o.id;const a=g.transaction([S],"readonly").objectStore(S).openCursor(null,"prev");let t=!1;a.onsuccess=e=>{const r=e.target.result;if(r){const{id:s,...i}=r.value,{id:d,...l}=o;if(JSON.stringify(i)===JSON.stringify(l)){t=!0;return}r.continue()}else if(!t){const d=g.transaction([S],"readwrite").objectStore(S).add(o);d.onsuccess=()=>{},d.onerror=l=>{console.error("Error saving pH data to IndexedDB:",l.target.errorCode)}}},a.onerror=e=>{console.error("Error checking for duplicate pH data in IndexedDB:",e.target.errorCode)}}function X(o){if(!g){console.warn("IndexedDB not open. Cannot save humidity data.");return}if(!o||typeof o!="object"){console.warn("Invalid humidity data. Not saving to IndexedDB.");return}"id"in o&&delete o.id;const a=g.transaction([h],"readonly").objectStore(h).openCursor(null,"prev");let t=!1;a.onsuccess=e=>{const r=e.target.result;if(r){const{id:s,...i}=r.value,{id:d,...l}=o;if(JSON.stringify(i)===JSON.stringify(l)){t=!0;return}r.continue()}else if(!t){const d=g.transaction([h],"readwrite").objectStore(h).add(o);d.onsuccess=()=>{},d.onerror=l=>{console.error("Error saving humidity data to IndexedDB:",l.target.errorCode)}}},a.onerror=e=>{console.error("Error checking for duplicate humidity data in IndexedDB:",e.target.errorCode)}}function R(o=8){return new Promise((n,c)=>{if(!g){console.warn("IndexedDB not open. Cannot get data."),n([]);return}const e=g.transaction([h],"readonly").objectStore(h).openCursor(null,"prev"),r=[];e.onsuccess=s=>{const i=s.target.result;i&&r.length<o?(r.push(i.value),i.continue()):n(r)},e.onerror=s=>{console.error("Error getting data from IndexedDB:",s.target.errorCode),c(s.target.errorCode)}})}function j(o=8){return new Promise((n,c)=>{if(!g){console.warn("IndexedDB not open. Cannot get data."),n([]);return}const e=g.transaction([S],"readonly").objectStore(S).openCursor(null,"prev"),r=[];e.onsuccess=s=>{const i=s.target.result;i&&r.length<o?(r.push(i.value),i.continue()):n(r)},e.onerror=s=>{console.error("Error getting data from IndexedDB:",s.target.errorCode),c(s.target.errorCode)}})}const G="a2spluztzgsdhl-ats.iot.ap-southeast-1.amazonaws.com",q="ap-southeast-1",Q="ap-southeast-1:e9f502ea-58c5-459a-bfa3-3ce6e1fc9bff";AWS.config.region=q;AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:Q});let v;const Z=async()=>{try{await new Promise((n,c)=>{AWS.config.credentials.get(a=>{a?c(a):n()})}),console.log("✅ Cognito Credentials loaded.");const o=tt.getSignedUrl(G,q,AWS.config.credentials.accessKeyId,AWS.config.credentials.secretAccessKey,AWS.config.credentials.sessionToken);v=mqtt.connect(o,{reconnectPeriod:5e3,clientId:"webclient_"+Math.floor(Math.random()*1e4),protocol:"wss",clean:!0}),v.on("connect",()=>{console.log("✅ MQTT connected")}),v.on("error",n=>{console.error("❌ MQTT Error:",n)})}catch(o){console.error("❌ Gagal load Cognito credentials:",o)}};window.nyalakanPompa=()=>{if(!v||!v.connected){console.error("🚫 MQTT belum terkoneksi. Tidak bisa publish.");return}const o=moment().format("YYYY-MM-DD HH:mm:ss"),n=document.getElementById("flushButton");n.classList.add("opacity-80"),n.disabled=!0,n.textContent="Sending ...",setTimeout(()=>{n.textContent="Flushing ..."},2e3),setTimeout(()=>{n.classList.remove("opacity-80"),n.disabled=!1,n.textContent="Flush"},3e4);const c=JSON.stringify({action:"nyala"});v.publish("device/pompa",c,{qos:1},a=>{a?console.error("🚫 Publish error:",a):console.log("📤 Pompa nyala command dikirim pada",o)})};const tt={getSignedUrl:function(o,n,c,a,t){const e=new Date,r=e.toISOString().slice(0,10).replace(/-/g,""),s=e.toISOString().replace(/[:-]|\.\d{3}/g,""),i="iotdevicegateway",d="AWS4-HMAC-SHA256",l="GET",m="/mqtt",b=r+"/"+n+"/"+i+"/aws4_request",C="X-Amz-Algorithm="+d+"&X-Amz-Credential="+encodeURIComponent(c+"/"+b)+"&X-Amz-Date="+s+"&X-Amz-SignedHeaders=host",N="host:"+o+`
`,E=AWS.util.crypto.sha256("","hex"),w=l+`
`+m+`
`+C+`
`+N+`
host
`+E,D=d+`
`+s+`
`+b+`
`+AWS.util.crypto.sha256(w,"hex"),x=AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac("AWS4"+a,r,"buffer"),n,"buffer"),i,"buffer"),"aws4_request","buffer"),T=AWS.util.crypto.hmac(x,D,"hex");let I="wss://"+o+m+"?"+C+"&X-Amz-Signature="+T;return t&&(I+="&X-Amz-Security-Token="+encodeURIComponent(t)),I}};let y;const z=()=>{if(y&&y.readyState!==WebSocket.CLOSED&&y.readyState!==WebSocket.CLOSING){console.log("WebSocket sudah aktif. Tidak membuat koneksi baru.");return}const o="wss://chili-monitor.andzuru.space";y=new WebSocket(o),y.onopen=async()=>{console.log("✅ WebSocket connected to",o),await W(),await F()},y.onmessage=n=>{try{const c=JSON.parse(n.data);console.log("📨 Data diterima:",c);const{topic:a,data:t,chartData:e,timestamp:r}=c,{ph:s,humidity:i}=e||{};let d=null;if(s&&Array.isArray(s.timestamps)&&s.timestamps.length>0){let u=s.timestamps[s.timestamps.length-1];typeof u=="string"&&u?d=new Date(u).toISOString():typeof u=="number"&&!isNaN(u)&&(u<1e10&&(u*=1e3),d=new Date(u).toISOString())}let l=null;if(i&&Array.isArray(i.timestamps)&&i.timestamps.length>0){let u=i.timestamps[i.timestamps.length-1];typeof u=="string"&&u?l=new Date(u).toISOString():typeof u=="number"&&!isNaN(u)&&(u<1e10&&(u*=1e3),l=new Date(u).toISOString())}const m=new Date(Date.now()+7*60*60*1e3),b=m.toISOString(),C=m-Number(r);let N,E;t&&(t.Kelembapan!==void 0&&t.Kelembapan!==null&&!isNaN(parseFloat(t.Kelembapan))?N={timestampCloudReceived:r,timestampBrowserReceived:b,latency:parseFloat(C),humidityValue:parseFloat(t.Kelembapan),humidityDataReceivedAt:l}:console.log("Kelembapan tidak ada pembaharuan data"),t.Ph!==void 0&&t.Ph!==null&&!isNaN(parseFloat(t.Ph))?E={timestampCloudReceived:r,timestampBrowserReceived:b,latency:parseFloat(C),phValue:parseFloat(t.Ph),phDataReceivedAt:d}:console.log("PH tidak ada pembaharuan data"));const w=parseFloat((t==null?void 0:t.Ph)??"NaN"),D=parseFloat((t==null?void 0:t.Kelembapan)??"NaN"),x=isNaN(w)?"N/A":w.toFixed(1),T=isNaN(D)?"N/A":D.toFixed(1),I=document.getElementById("phValue"),k=document.getElementById("humidityValue"),M=document.getElementById("ground-good-status"),$=document.getElementById("ground-poor-status");if(!isNaN(w)&&!isNaN(D)&&(w>8.5||w<5.5||D>90||D<10)?(M.classList.add("hidden"),$.classList.remove("hidden")):($.classList.add("hidden"),M.classList.remove("hidden")),I&&(I.textContent=x),k&&(k.textContent=T),e){if(s&&Array.isArray(s.timestamps)&&Array.isArray(s.values)){const u=s.timestamps.map(Number),H=s.values.map(Number);navigator.onLine?(et(u,H),J(E)):j(1).then(A=>{A&&A.length>0&&setTimeout(W,200)})}if(i&&Array.isArray(i.timestamps)&&Array.isArray(i.values)){const u=i.timestamps.map(Number),H=i.values.map(Number);navigator.onLine?(at(u,H),X(N)):R(1).then(A=>{A&&A.length>0&&setTimeout(F,200)})}}}catch(c){console.error("❌ Error parsing WebSocket message:",c)}},y.onerror=n=>{console.error("⚠️ WebSocket error:",n)},y.onclose=n=>{console.warn(`⚠️ WebSocket disconnected. Code: ${n.code}, Reason: ${n.reason}`),setTimeout(()=>{console.log("🔁 Mencoba reconnect WebSocket..."),z()},5e3)}};document.addEventListener("DOMContentLoaded",()=>{z(),Z(),Y().then(()=>{}).catch(o=>console.error("Failed to open IndexedDB:",o))});async function W(){const o=await j();if(!o||o.length===0){p.data.datasets[0].data=[],p.data.labels=[],p.update();return}const n=o.slice().reverse(),c=n.map(t=>{const e=new Date(t.phDataReceivedAt),r=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),d=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${r}-${s}-${i} ${d}:${l}:${m}`}),a=n.map(t=>t.phValue);p.data.datasets[0].data=a,p.data.labels=c,p.update()}function et(o,n){function c(t){const e=new Date(t),r=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),d=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${r}-${s}-${i} ${d}:${l}:${m}`}const a=o.map(t=>c(t));p.data.datasets[0].data=n,p.data.labels=a,p.update()}const ot={labels:[],datasets:[{label:"Soil pH",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2}]},nt={type:"line",data:ot,options:{scales:{y:{beginAtZero:!1}}}},p=new Chart(document.getElementById("myChart1"),nt);async function F(){const o=await R();if(!o||o.length===0){f.data.datasets[0].data=[],f.data.labels=[],f.update();return}const n=o.slice().reverse(),c=n.map(t=>{const e=new Date(t.humidityDataReceivedAt),r=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),d=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${r}-${s}-${i} ${d}:${l}:${m}`}),a=n.map(t=>t.humidityValue);f.data.datasets[0].data=a,f.data.labels=c,f.update()}function at(o,n){function c(t){const e=new Date(t),r=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),d=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${r}-${s}-${i} ${d}:${l}:${m}`}const a=o.map(t=>c(t));console.log(a),f.data.datasets[0].data=n,f.data.labels=a,f.update()}const rt={labels:[],datasets:[{label:"Soil Moisture",data:[],borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:2}]},st={type:"line",data:rt,options:{scales:{y:{beginAtZero:!1}}}},f=new Chart(document.getElementById("myChart"),st),B=document.querySelector("#hamburger"),O=document.querySelector("#nav-menu");B.addEventListener("click",function(){B.classList.toggle("hamburger-active"),O.classList.toggle("hidden")});window.addEventListener("click",function(o){o.target!=B&&o.target!=O&&(B.classList.remove("hamburger-active"),O.classList.add("hidden"))});const P=document.getElementById("modal-container-1"),L=document.getElementById("modal-container-2"),it=document.getElementById("modal-main"),K=document.getElementById("info-button"),ct=document.getElementById("close-modal");K.addEventListener("click",()=>{P.classList.remove("hidden"),L.classList.remove("hidden")});ct.addEventListener("click",()=>{P.classList.add("hidden"),L.classList.add("hidden")});window.addEventListener("click",function(o){!it.contains(o.target)&&!K.contains(o.target)&&(P.classList.add("hidden"),L.classList.add("hidden"))});function U(){const o=moment(),n=o.hour(),c=o.minute(),a=o.second(),t=o.format("HH : mm : ss");document.getElementById("clock").textContent=t;let e;n<7||n===7&&c===0&&a===0?e=moment().hour(7).minute(0).second(0):e=moment().add(1,"days").hour(7).minute(0).second(0),n===7&&c===0&&a===0&&nyalakanPompa();const r=moment.duration(e.diff(o)),s=String(r.hours()).padStart(2,"0"),i=String(r.minutes()).padStart(2,"0"),d=String(r.seconds()).padStart(2,"0"),l=`${s}`,m=`${i}`,b=`${d}`;document.getElementById("countdownHour").textContent=l,document.getElementById("countdownMinute").textContent=m,document.getElementById("countdownSecond").textContent=b}setInterval(U,1e3);U();
