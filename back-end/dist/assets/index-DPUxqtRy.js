(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const e of o)if(e.type==="childList")for(const a of e.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function i(o){const e={};return o.integrity&&(e.integrity=o.integrity),o.referrerPolicy&&(e.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?e.credentials="include":o.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(o){if(o.ep)return;o.ep=!0;const e=i(o);fetch(o.href,e)}})();const et="SensorMonitorDB",ot=1,y="humidityUpdates",S="phUpdates";let p;function nt(){return new Promise((t,n)=>{const i=indexedDB.open(et,ot);i.onerror=s=>{console.error("Error opening IndexedDB:",s.target.errorCode),n(s.target.errorCode)},i.onsuccess=s=>{p=s.target.result,console.log("IndexedDB opened successfully"),t(p)},i.onupgradeneeded=s=>{const o=s.target.result;o.objectStoreNames.contains(S)||(o.createObjectStore(S,{keyPath:"id",autoIncrement:!0}),console.log(`Object store '${S}' created.`)),o.objectStoreNames.contains(y)||(o.createObjectStore(y,{keyPath:"id",autoIncrement:!0}),console.log(`Object store '${y}' created.`))}})}function at(t){if(!p){console.warn("IndexedDB not open. Cannot save pH data.");return}if(!t||typeof t!="object"){console.warn("Invalid pH data. Not saving to IndexedDB.");return}"id"in t&&delete t.id;const s=p.transaction([S],"readonly").objectStore(S).openCursor(null,"prev");let o=!1;s.onsuccess=e=>{const a=e.target.result;if(a){if(a.value.phValue===t.phValue){o=!0;return}a.continue()}else if(!o){const l=p.transaction([S],"readwrite").objectStore(S).add(t);l.onsuccess=()=>{},l.onerror=u=>{console.error("Error saving pH data to IndexedDB:",u.target.errorCode)}}},s.onerror=e=>{console.error("Error checking for duplicate pH data in IndexedDB:",e.target.errorCode)}}function rt(t){if(!p){console.warn("IndexedDB not open. Cannot save humidity data.");return}if(!t||typeof t!="object"){console.warn("Invalid humidity data. Not saving to IndexedDB.");return}"id"in t&&delete t.id;const s=p.transaction([y],"readonly").objectStore(y).openCursor(null,"prev");let o=!1;s.onsuccess=e=>{const a=e.target.result;if(a){if(a.value.humidityValue===t.humidityValue){o=!0;return}a.continue()}else if(!o){const l=p.transaction([y],"readwrite").objectStore(y).add(t);l.onsuccess=()=>{},l.onerror=u=>{console.error("Error saving humidity data to IndexedDB:",u.target.errorCode)}}},s.onerror=e=>{console.error("Error checking for duplicate phValue in IndexedDB:",e.target.errorCode)}}function K(t=8){return new Promise((n,i)=>{if(!p){console.warn("IndexedDB not open. Cannot get data."),n([]);return}const e=p.transaction([y],"readonly").objectStore(y).openCursor(null,"prev"),a=[];e.onsuccess=r=>{const d=r.target.result;d&&a.length<t?(a.push(d.value),d.continue()):n(a)},e.onerror=r=>{console.error("Error getting data from IndexedDB:",r.target.errorCode),i(r.target.errorCode)}})}function Y(t=8){return new Promise((n,i)=>{if(!p){console.warn("IndexedDB not open. Cannot get data."),n([]);return}const e=p.transaction([S],"readonly").objectStore(S).openCursor(null,"prev"),a=[];e.onsuccess=r=>{const d=r.target.result;d&&a.length<t&&(a.push(d.value),d.continue())},e.onerror=r=>{console.error("Error getting data from IndexedDB:",r.target.errorCode),i(r.target.errorCode)}})}function st(t="ph_data.csv"){return new Promise((n,i)=>{if(!p){console.warn("IndexedDB not open. Cannot get data."),i("IndexedDB not open");return}const e=p.transaction([S],"readonly").objectStore(S).openCursor();let a=[],r=[],d=!0;e.onsuccess=l=>{const u=l.target.result;if(u){const m=u.value;d&&(r=Object.keys(m),a.push(r.join(",")),d=!1);const h=r.map(f=>{let c=m[f];return c===null||typeof c>"u"?"":typeof c=="string"&&(c.includes(",")||c.includes('"')||c.includes(`
`))?`"${c.replace(/"/g,'""')}"`:c}).join(",");a.push(h),u.continue()}else{console.log("semua data telah diiterasi");const m=a.join(`
`),h=new Blob([m],{type:"text/csv;charset=utf-8;"}),f=URL.createObjectURL(h),c=document.createElement("a");c.href=f,c.download=t,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(f),console.log(`Data exported to ${t}`),n()}},e.onerror=l=>{console.error("Error download data from IndexedDB:",l.target.errorCode),i(l.target.errorCode)}})}function it(t="humidity_data.csv"){return new Promise((n,i)=>{if(!p){console.warn("IndexedDB not open. Cannot get data."),i("IndexedDB not open");return}const e=p.transaction([y],"readonly").objectStore(y).openCursor();let a=[],r=[],d=!0;e.onsuccess=l=>{const u=l.target.result;if(u){const m=u.value;d&&(r=Object.keys(m),a.push(r.join(",")),d=!1);const h=r.map(f=>{let c=m[f];return c===null||typeof c>"u"?"":typeof c=="string"&&(c.includes(",")||c.includes('"')||c.includes(`
`))?`"${c.replace(/"/g,'""')}"`:c}).join(",");a.push(h),u.continue()}else{console.log("semua data telah diiterasi");const m=a.join(`
`),h=new Blob([m],{type:"text/csv;charset=utf-8;"}),f=URL.createObjectURL(h),c=document.createElement("a");c.href=f,c.download=t,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(f),console.log(`Data exported to ${t}`),n()}},e.onerror=l=>{console.error("Error download data from IndexedDB:",l.target.errorCode),i(l.target.errorCode)}})}const dt="a2spluztzgsdhl-ats.iot.ap-southeast-1.amazonaws.com",X="ap-southeast-1",ct="ap-southeast-1:e9f502ea-58c5-459a-bfa3-3ce6e1fc9bff";AWS.config.region=X;AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:ct});let L;const lt=async()=>{try{await new Promise((n,i)=>{AWS.config.credentials.get(s=>{s?i(s):n()})}),console.log("✅ Cognito Credentials loaded.");const t=ut.getSignedUrl(dt,X,AWS.config.credentials.accessKeyId,AWS.config.credentials.secretAccessKey,AWS.config.credentials.sessionToken);L=mqtt.connect(t,{reconnectPeriod:5e3,clientId:"webclient_"+Math.floor(Math.random()*1e4),protocol:"wss",clean:!0}),L.on("connect",()=>{console.log("✅ MQTT connected")}),L.on("error",n=>{console.error("❌ MQTT Error:",n)})}catch(t){console.error("❌ Gagal load Cognito credentials:",t)}};window.nyalakanPompa=()=>{if(!L||!L.connected){console.error("🚫 MQTT belum terkoneksi. Tidak bisa publish.");return}const t=moment().format("YYYY-MM-DD HH:mm:ss"),n=document.getElementById("flushButton");n.classList.add("opacity-80"),n.disabled=!0,n.textContent="Sending ...",setTimeout(()=>{n.textContent="Flushing ..."},2e3),setTimeout(()=>{n.classList.remove("opacity-80"),n.disabled=!1,n.textContent="Flush"},3e4);const i=JSON.stringify({action:"nyala"});L.publish("device/pompa",i,{qos:1},s=>{s?console.error("🚫 Publish error:",s):console.log("📤 Pompa nyala command dikirim pada",t)})};const ut={getSignedUrl:function(t,n,i,s,o){const e=new Date,a=e.toISOString().slice(0,10).replace(/-/g,""),r=e.toISOString().replace(/[:-]|\.\d{3}/g,""),d="iotdevicegateway",l="AWS4-HMAC-SHA256",u="GET",m="/mqtt",h=a+"/"+n+"/"+d+"/aws4_request",f="X-Amz-Algorithm="+l+"&X-Amz-Credential="+encodeURIComponent(i+"/"+h)+"&X-Amz-Date="+r+"&X-Amz-SignedHeaders=host",c="host:"+t+`
`,T=AWS.util.crypto.sha256("","hex"),H=u+`
`+m+`
`+f+`
`+c+`
host
`+T,C=l+`
`+r+`
`+h+`
`+AWS.util.crypto.sha256(H,"hex"),v=AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac(AWS.util.crypto.hmac("AWS4"+s,a,"buffer"),n,"buffer"),d,"buffer"),"aws4_request","buffer"),M=AWS.util.crypto.hmac(v,C,"hex");let j="wss://"+t+m+"?"+f+"&X-Amz-Signature="+M;return o&&(j+="&X-Amz-Security-Token="+encodeURIComponent(o)),j}};let D;const G=()=>{if(D&&D.readyState!==WebSocket.CLOSED&&D.readyState!==WebSocket.CLOSING){console.log("WebSocket sudah aktif. Tidak membuat koneksi baru.");return}const t="wss://chili-monitor.andzuru.space";D=new WebSocket(t),D.onopen=async()=>{console.log("✅ WebSocket connected to",t)},D.onmessage=n=>{try{const i=JSON.parse(n.data);console.log("📨 Data diterima:",i);const{topic:s,data:o,chartData:e,timestamp:a}=i,{ph:r,humidity:d}=e||{};let l=null;if(r&&Array.isArray(r.timestamps)&&r.timestamps.length>0){let g=r.timestamps[r.timestamps.length-1];typeof g=="string"&&g?l=new Date(g).toISOString():typeof g=="number"&&!isNaN(g)&&(g<1e10&&(g*=1e3),l=new Date(g).toISOString())}let u=null;if(d&&Array.isArray(d.timestamps)&&d.timestamps.length>0){let g=d.timestamps[d.timestamps.length-1];typeof g=="string"&&g?u=new Date(g).toISOString():typeof g=="number"&&!isNaN(g)&&(g<1e10&&(g*=1e3),u=new Date(g).toISOString())}const m=Date.now(),h=isNaN(Number(a))?0:m-Number(a),f=isNaN(Number(a))?null:new Date(Number(a)+7*60*60*1e3).toISOString(),c=new Date(m+7*60*60*1e3).toISOString();let T,H;o&&(o.Kelembapan!==void 0&&o.Kelembapan!==null&&!isNaN(parseFloat(o.Kelembapan))?(window.latestRecordHumidity={timestampCloudReceived:f,timestampBrowserReceived:c,latency:parseFloat(h),humidityValue:parseFloat(o.Kelembapan),humidityDataReceivedAt:u},T=window.latestRecordHumidity):console.log("Kelembapan tidak ada pembaharuan data"),o.Ph!==void 0&&o.Ph!==null&&!isNaN(parseFloat(o.Ph))?(window.latestRecordPh={timestampCloudReceived:f,timestampBrowserReceived:c,latency:parseFloat(h),phValue:parseFloat(o.Ph),phDataReceivedAt:l},H=window.latestRecordPh):console.log("PH tidak ada pembaharuan data"));const C=parseFloat((o==null?void 0:o.Ph)??"NaN"),v=parseFloat((o==null?void 0:o.Kelembapan)??"NaN"),M=isNaN(C)?"N/A":C.toFixed(1),j=isNaN(v)?"N/A":v.toFixed(1),U=document.getElementById("phValue"),V=document.getElementById("humidityValue"),z=document.getElementById("ground-good-status"),_=document.getElementById("ground-poor-status");if(!isNaN(C)&&!isNaN(v)&&(C>8.5||C<5.5||v>90||v<10)?(z.classList.add("hidden"),_.classList.remove("hidden")):(_.classList.add("hidden"),z.classList.remove("hidden")),U&&(U.textContent=M),V&&(V.textContent=j),e){if(r&&Array.isArray(r.timestamps)&&Array.isArray(r.values)){const g=r.timestamps.map(Number),O=r.values.map(Number);navigator.onLine?(gt(g,O),at(H)):Y(1).then(N=>{N&&N.length>0&&setTimeout(mt,200)})}if(d&&Array.isArray(d.timestamps)&&Array.isArray(d.values)){const g=d.timestamps.map(Number),O=d.values.map(Number);navigator.onLine?(yt(g,O),rt(T)):K(1).then(N=>{N&&N.length>0&&setTimeout(ft,200)})}}}catch(i){console.error("❌ Error parsing WebSocket message:",i)}},D.onerror=n=>{console.error("⚠️ WebSocket error:",n)},D.onclose=n=>{console.warn(`⚠️ WebSocket disconnected. Code: ${n.code}, Reason: ${n.reason}`),setTimeout(()=>{console.log("🔁 Mencoba reconnect WebSocket..."),G()},5e3)}};document.addEventListener("DOMContentLoaded",()=>{G(),lt(),nt().then(()=>{}).catch(t=>console.error("Failed to open IndexedDB:",t))});async function mt(){const t=await Y();if(!t||t.length===0){b.data.datasets[0].data=[],b.data.labels=[],b.update();return}const n=t.slice().reverse(),i=n.map(o=>{const e=new Date(o.phDataReceivedAt),a=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),d=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${a}-${r}-${d} ${l}:${u}:${m}`}),s=n.map(o=>o.phValue);b.data.datasets[0].data=s,b.data.labels=i,b.update()}function gt(t,n){function i(o){const e=new Date(o),a=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),d=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${a}-${r}-${d} ${l}:${u}:${m}`}const s=t.map(o=>i(o));b.data.datasets[0].data=n,b.data.labels=s,b.update()}const pt={labels:[],datasets:[{label:"Soil pH",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2}]},ht={type:"line",data:pt,options:{scales:{y:{beginAtZero:!1}}}},b=new Chart(document.getElementById("myChart1"),ht);async function ft(){const t=await K();if(!t||t.length===0){w.data.datasets[0].data=[],w.data.labels=[],w.update();return}const n=t.slice().reverse(),i=n.map(o=>{const e=new Date(o.humidityDataReceivedAt),a=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),d=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${a}-${r}-${d} ${l}:${u}:${m}`}),s=n.map(o=>o.humidityValue);w.data.datasets[0].data=s,w.data.labels=i,w.update()}function yt(t,n){function i(o){const e=new Date(o),a=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),d=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${a}-${r}-${d} ${l}:${u}:${m}`}const s=t.map(o=>i(o));console.log(s),w.data.datasets[0].data=n,w.data.labels=s,w.update()}const St={labels:[],datasets:[{label:"Soil Moisture",data:[],borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:2}]},bt={type:"line",data:St,options:{scales:{y:{beginAtZero:!1}}}},w=new Chart(document.getElementById("myChart"),bt),k=document.querySelector("#hamburger"),$=document.querySelector("#nav-menu");k.addEventListener("click",function(){k.classList.toggle("hamburger-active"),$.classList.toggle("hidden")});window.addEventListener("click",function(t){t.target!=k&&t.target!=$&&(k.classList.remove("hamburger-active"),$.classList.add("hidden"))});const R=document.getElementById("modal-container-1"),P=document.getElementById("modal-container-2"),x=document.getElementById("modal-confirm-download-container"),A=document.getElementById("modal-confirm-download-alert"),wt=document.getElementById("modal-main"),Dt=document.getElementById("modal-main-download"),Q=document.getElementById("info-button"),J=document.getElementById("close-modal"),I=document.getElementById("download-data"),F=document.getElementById("cancel-download"),W=document.getElementById("get-ph-data-modal"),q=document.getElementById("get-humidity-data-modal"),E=document.getElementById("content-download-modal"),Z=document.getElementById("title-download-modal");let B=null;Q.addEventListener("click",()=>{R.classList.remove("hidden"),P.classList.remove("hidden")});W.addEventListener("click",()=>{x.classList.remove("hidden"),A.classList.remove("hidden"),B="ph",Z.textContent="Download PH Data",E.textContent="Do you want to download the pH data?"});q.addEventListener("click",()=>{x.classList.remove("hidden"),A.classList.remove("hidden"),B="humidity",Z.textContent="Download Humidity Data",E.textContent="Do you want to download the humidity data?"});I.addEventListener("click",()=>{B==="ph"?(I.disabled=!0,E.textContent="Mengunduh data pH...",setTimeout(async()=>{await st()},4e3),setTimeout(()=>{I.disabled=!1,E.textContent="Data pH berhasil diunduh."},1500)):B==="humidity"&&(I.disabled=!0,E.textContent="Mengunduh data kelembapan...",setTimeout(async()=>{await it()},4e3),setTimeout(()=>{I.disabled=!1,E.textContent="Data humidity berhasil diunduh."},1500)),setTimeout(()=>{x.classList.add("hidden"),A.classList.add("hidden"),B=null},5e3)});F.addEventListener("click",()=>{x.classList.add("hidden"),A.classList.add("hidden"),B=null});J.addEventListener("click",()=>{R.classList.add("hidden"),P.classList.add("hidden")});window.addEventListener("click",function(t){!x.classList.contains("hidden")&&!A.classList.contains("hidden")?!Dt.contains(t.target)&&t.target!==I&&t.target!==F&&t.target!==W&&t.target!==q&&(x.classList.add("hidden"),A.classList.add("hidden"),B=null):!R.classList.contains("hidden")&&!P.classList.contains("hidden")&&!wt.contains(t.target)&&t.target!==I&&t.target!==Q&&t.target!==J&&t.target!==F&&t.target!==W&&t.target!==q&&(R.classList.add("hidden"),P.classList.add("hidden"))});function tt(){const t=moment(),n=t.hour(),i=t.minute(),s=t.second(),o=t.format("HH : mm : ss");document.getElementById("clock").textContent=o;let e;n<7||n===7&&i===0&&s===0?e=moment().hour(7).minute(0).second(0):e=moment().add(1,"days").hour(7).minute(0).second(0),n===7&&i===0&&s===0&&nyalakanPompa();const a=moment.duration(e.diff(t)),r=String(a.hours()).padStart(2,"0"),d=String(a.minutes()).padStart(2,"0"),l=String(a.seconds()).padStart(2,"0"),u=`${r}`,m=`${d}`,h=`${l}`;document.getElementById("countdownHour").textContent=u,document.getElementById("countdownMinute").textContent=m,document.getElementById("countdownSecond").textContent=h}setInterval(tt,1e3);tt();
